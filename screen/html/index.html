<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>智慧创城巡访</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
        <link rel="stylesheet" href="../css/core.css"/>
		<link rel="stylesheet" type="text/css" media="all" href="../components/daterangepicker-bs3.css" />
        <link rel="stylesheet" href="../components/jquery.messagetip.css"/>
        <script src="../js/jquery.js"></script>
        <script src="../components/jquery.messagetip.js"></script>
        <script src="../js/flexible.js"></script>
        <script src="../js/echarts.min.js"></script>
        <script src="../js/config.js"></script>
        <script src="../js/areaIcon.js"></script>
        <script src="../components/moment.js"></script>
        <script src="../components/daterangepicker.js"></script>
        <script charset="utf-8" src="https://map.qq.com/api/gljs?v=1.exp&key=VGNBZ-YUX66-E4KSV-M43JP-PTXQF-MYB2O"></script>
    </head>
    
    <body class='body'>
        <div id="container" class="container"></div>
        <div class='maxBg'>

            <!--- 遮罩bg -->
            <div class='optionBg hide'></div>
            <!-- alert 提示bg --->
            
            <!--显示消息通知-->
            <div class='noticeBox hide'>
                <div class='container'>
                    <div class='position'>
                        <div class='leftIcon'></div>
                        <div class='cont' >
                            <div class='noticeImgBox' id='noticeImgs'></div>
                            <div class='texts' id='noticeId'></div>
                        </div>
                        <div class='rightIcon' onclick="hideNotice()"></div>
                    </div>
                </div>
            </div>
            <!-- 右侧消息通知显示 -->
            <div class='noticeIcon hide' onclick="showNotice()"></div>

            <!-- 顶部 -->
            <div class='topBg'>
                <div class='leftBg'>
                    <div class='time time2'></div>
                    <div class='time time1 big hide'></div>
                </div>
                <div class='centerBg'>
                    <div class='title hide'>浦东城市大脑 —— 智慧创全</div>
                </div>
                <div class='rightBg'>
                    <div class='time times'>2019年12月12日 星期一</div>
                    <div class='time big'>08:12:12</div>
                </div>
            </div>
            <!-- 图例说明 -->
            <div class='explain'></div>
            <!-- 左侧按钮 -->
            <div class='leftBtn'>
                <div class='leftbtnIcon btn1'></div>
                <div class='leftbtnIcon btn3'></div>
                <div class='leftbtnIcon btn2'></div>
            </div>
            <!-- 综合信息，统计 -->
            <div class='allDiv mess-statis hide'>
                <div class='close'>
                    <div class='icon'></div>
                </div>
                <div class='statis-left'>
                    <div class='statis-left-top'>
                        <div class='linebgs'></div>
                        <div class='title'>统计概览</div>
                        <div class='content'>
                            <ul class='ul'>
                                <li>
                                    <span class='label'>街道</span>
                                    <span class='num'>36</span>
                                    <span class='man'>个</span>
                                </li>
                                <li>
                                    <span class='label'>委办局</span>
                                    <span class='num'>15</span>
                                    <span class='man'>个</span>
                                </li>
                                <li>
                                    <span class='label'>点位长</span>
                                    <span class='num mans-dotRole'></span>
                                    <span class='man'>人</span>
                                </li>
                                <li>
                                    <span class='label'>巡查人员</span>
                                    <span class='num mans-dotPatro'></span>
                                    <span class='man'>人</span>
                                </li>
                                <li>
                                    <span class='label'>点位</span>
                                    <span class='num mans-point'></span>
                                    <span class='man'>个</span>
                                </li>
                                
                                <li>
                                    <span class='label'>日常点位</span>
                                    <span class='num totalNum'>10</span>
                                    <span class='man'>个</span>
                                </li>
                                <li>
                                    <span class='label'>随机点位</span>
                                    <span class='num suiji'>20</span>
                                    <span class='man'>个</span>
                                </li>
                                
                            </ul>
                        </div>
                    </div>
                    <div class='statis-left-center'>
                        <div class='linebgs'></div>
                        <div class='title'>点位统计</div>
                        <div class='content'>
                            <div class='content-left charts' id='showChart'></div>
                            <div class='content-right'>
                                <div class='dot-top-right-t'>
                                    <div class='cont'>
                                    <div class='flex'>
                                            <div class='icon icon-blue'></div>
                                            <div class='number stay_check'></div>
                                    </div>
                                    <div class='desc'>待巡查</div>
                                    </div>
                                </div>
                                <div class='dot-top-right-t'>
                                    <div class='cont'>
                                        <div class='flex'>
                                            <div class='icon icon-red'></div>
                                            <div class='number stay_fix'></div>
                                        </div>
                                    <div class='desc'>待处理</div>
                                    </div>
                                </div>
                                <div class='dot-top-right-t noBorderR'>
                                    <div class='cont'>
                                        <div class='flex'>
                                            <div class='icon icon-yellow'></div>
                                            <div class='number stay_review'></div>
                                    </div>
                                    <div class='desc'>已处理</div>
                                    </div>
                                </div>
                                <div class='dot-top-right-t noBorder'>
                                    <div class='cont'>
                                        <div class='flex'>
                                            <div class='icon icon-orange'></div>
                                            <div class='number fixing'></div>
                                    </div>
                                    <div class='desc'>处理中</div>
                                    </div>
                                </div>
                                <div class='dot-top-right-t noBorder'>
                                    <div class='cont'>
                                        <div class='flex'>
                                            <div class='icon icon-green'></div>
                                            <div class='number pass_count'></div>
                                    </div>
                                    <div class='desc'>合格</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class='statis-left-btm'>
                        <div class='linebgs'></div>
                        <div class='title'>问题统计</div>
                        <div class='content' id='problem-statis'></div>
                    </div>
                </div>
                <div class='statis-right'>
                    <div class='linebgs'></div>
                    <div class='title'>组织架构</div>
                    <div class='titleBlue'>查看巡检流程</div>
                    <div class='content'>
                        <img src='../images/zuzhi.png' class="img"/>
                    </div>
                </div>
                <!-- 巡检流程 -->
                <div class='Patrol2 hide'>
                    <div class='linebgs'></div>
                    <div class='title'>巡检流程</div>
                    <div class='content'>
                        <img src='../images/patrol.png' class="img"/>
                    </div>
                </div>
            </div>

            <!-- 巡检流程 -->
            <div class='allDiv Patrol blueBackBg hide'>
                <div class='close'>
                    <div class='icon'></div>
                </div>
                <div class='linebg lineBg-lt'></div>
                <div class='linebg lineBg-lb'></div>
                <div class='linebg lineBg-rt'></div>
                <div class='linebg lineBg-rb'></div>
                <div class='title'>巡检流程</div>
                <div class='content'>
                    <img src='../images/patrol.png' class="img"/>
                </div>
            </div>
            
            <!-- 日常保障--点位巡查统计 -->
            <div class='allDiv dot-statis blueBackBg hide'>
                <div class='close'>
                    <div class='icon'></div>
                </div>
                <div class='linebg lineBg-lt'></div>
                <div class='linebg lineBg-lb'></div>
                <div class='linebg lineBg-rt'></div>
                <div class='linebg lineBg-rb'></div>
                <div class='title'>点位巡查统计</div>
                <div class='hrefs' onclick="getStatis('')">查看详情</div>
                <div class='content dot-statis-content'>
                    <ul class='ul' id='dot-statis-number'>
                        <li>
                            <div class='block'>
                                <div class='display'>
                                    <span class='label'>点位数</span>
                                    <span class='num totalNum'>854</span>
                                </div>
                                <div class='display'>
                                    <span class='label'>巡查员</span>
                                    <span class='num totalMan'>35</span>
                                </div>
                            </div>
                        </li>
                        <li class='number1'>
                            <div class='left-box'>
                                <div class="pie">
                                    <div class="circle"></div>
                                    <div class="left">
                                    <div class="left-deg green"></div>
                                    </div>
                                    <div class="right">
                                    <div class="right-deg green"></div>
                                    </div>
                                    <div class='num'><span class='nums'></span><strong class='small'>%</strong></div>
                                </div>
                            </div>
                            <div class='right-box'>
                                <div class='num'></div>
                                <div class='name'>合格</div>
                            </div>
                        </li>
                        <li class='number2'>
                            <div class='left-box'>
                                <div class="pie">
                                    <div class="circle"></div>
                                    <div class="left">
                                    <div class="left-deg blue"></div>
                                    </div>
                                    <div class="right">
                                    <div class="right-deg blue"></div>
                                    </div>
                                    <div class='num'><span class='nums'>15</span><strong class='small'>%</strong></div>
                                </div>
                            </div>
                            <div class='right-box'>
                                <div class='num'>25</div>
                                <div class='name'>待巡查</div>
                            </div>
                        </li>
                        <li class='number3'>
                            <div class='left-box'>
                                <div class="pie">
                                    <div class="circle"></div>
                                    <div class="left">
                                    <div class="left-deg yellow"></div>
                                    </div>
                                    <div class="right">
                                    <div class="right-deg yellow"></div>
                                    </div>
                                    <div class='num'><span class='nums'>15</span><strong class='small'>%</strong></div>
                                </div>
                            </div>
                            <div class='right-box'>
                                <div class='num'>20</div>
                                <div class='name'>已处理</div>
                            </div>
                        </li>
                        <li class='noborder number4'>
                            <div class='left-box'>
                                <div class="pie">
                                    <div class="circle"></div>
                                    <div class="left">
                                    <div class="left-deg orange"></div>
                                    </div>
                                    <div class="right">
                                    <div class="right-deg orange"></div>
                                    </div>
                                    <div class='num'><span class='nums'>15</span><strong class='small'>%</strong></div>
                                </div>
                            </div>
                            <div class='right-box'>
                                <div class='num'>6</div>
                                <div class='name'>处理中</div>
                            </div>
                        </li>
                        <li class='noborder number5'>
                            <div class='left-box'>
                                <div class="pie">
                                    <div class="circle"></div>
                                    <div class="left">
                                    <div class="left-deg red"></div>
                                    </div>
                                    <div class="right">
                                    <div class="right-deg red"></div>
                                    </div>
                                    <div class='num'><span class='nums'>15</span><strong class='small'>%</strong></div>
                                </div>
                            </div>
                            <div class='right-box'>
                                <div class='num'>65</div>
                                <div class='name'>待处理</div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- 街镇排名 -->
            <div class='allDiv street-statis blueBackBg hide'>
                <div class='close'>
                    <div class='icon'></div>
                </div>
                <div class='linebg lineBg-lt'></div>
                <div class='linebg lineBg-lb'></div>
                <div class='linebg lineBg-rt'></div>
                <div class='linebg lineBg-rb'></div>
                <div class='title titleBox'>
                    <span class='text active'>街镇概览</span>
                    <span class='text'>单位概览</span>
                </div>
                <div class='underLineBg'></div>
                <div class='titleBoxChoose'>
                    <div class='left'>
                        <span class='text active'>全部</span>
                        <span class='text'>日常</span>
                        <span class='text'>随机</span>
                    </div>
                    <div class='right'>
                        <select class='select' defaultValue='0' onclick="selectchange(this.options[this.options.selectedIndex].value)">
                            <Option value='0' class='option'>点位数</Option>
                            <Option value='1' class='option'>巡防数</Option>
                            <Option value='2' class='option'>合格数</Option>
                            <Option value='3' class='option'>不合格数</Option>
                            <Option value='4' class='option'>整改数</Option>
                            <Option value='5' class='option'>合格率</Option>
                            <Option value='6' class='option'>巡查率</Option>
                            <Option value='7' class='option'>整改率</Option>
                        </select>
                    </div>
                </div>
                <div class='content'>
                    <div class='cont' id='street-statis'></div>
                </div>
            </div>
            <!-- 街镇详情 -->
            <div class='allDiv street-detail blueBackBg hide'>
                <div class='close'>
                    <div class='icon'></div>
                </div>
                <div class='linebg lineBg-lt'></div>
                <div class='linebg lineBg-lb'></div>
                <div class='linebg lineBg-rt'></div>
                <div class='linebg lineBg-rb'></div>
                <div class='title' id='streetName'>金桥街道</div>
                <div class='hrefs' onclick="getStatis('1')">查看详情</div>
                <div class='content-man hide'>
                    <span class='label'>负责人</span>
                    <span class='name'>小喜哥</span>
                    <span class='phone'>18423013466</span>
                </div>
                <div class='content dot-statis-content'>
                    <ul class='ul'>
                        <li>
                            <div class='block'>
                                <div class='display'>
                                    <span class='label'>点位数</span>
                                    <span class='num totalNum'>854</span>
                                </div>
                            </div>
                        </li>
                        <li class='number1'>
                            <div class='left-box'>
                                <div class="pie">
                                    <div class="circle"></div>
                                    <div class="left">
                                    <div class="left-deg green"></div>
                                    </div>
                                    <div class="right">
                                    <div class="right-deg green"></div>
                                    </div>
                                    <div class='num'><span class='nums'></span><strong class='small'>%</strong></div>
                                </div>
                            </div>
                            <div class='right-box'>
                                <div class='num'>31</div>
                                <div class='name'>合格</div>
                            </div>
                        </li>
                        <li class='number2'>
                            <div class='left-box'>
                                <div class="pie">
                                    <div class="circle"></div>
                                    <div class="left">
                                    <div class="left-deg blue"></div>
                                    </div>
                                    <div class="right">
                                    <div class="right-deg blue"></div>
                                    </div>
                                    <div class='num'><span class='nums'></span><strong class='small'>%</strong></div>
                                </div>
                            </div>
                            <div class='right-box'>
                                <div class='num'>25</div>
                                <div class='name'>待巡查</div>
                            </div>
                        </li>
                        <li class='number3'>
                            <div class='left-box'>
                                <div class="pie">
                                    <div class="circle"></div>
                                    <div class="left">
                                    <div class="left-deg yellow"></div>
                                    </div>
                                    <div class="right">
                                    <div class="right-deg yellow"></div>
                                    </div>
                                    <div class='num'><span class='nums'></span><strong class='small'>%</strong></div>
                                </div>
                            </div>
                            <div class='right-box'>
                                <div class='num'>20</div>
                                <div class='name'>已处理</div>
                            </div>
                        </li>
                        <li class='noborder number4'>
                            <div class='left-box'>
                                <div class="pie">
                                    <div class="circle"></div>
                                    <div class="left">
                                    <div class="left-deg orange"></div>
                                    </div>
                                    <div class="right">
                                    <div class="right-deg orange"></div>
                                    </div>
                                    <div class='num'><span class='nums'></span><strong class='small'>%</strong></div>
                                </div>
                            </div>
                            <div class='right-box'>
                                <div class='num'>6</div>
                                <div class='name'>处理中</div>
                            </div>
                        </li>
                        <li class='noborder number5'>
                            <div class='left-box'>
                                <div class="pie">
                                    <div class="circle"></div>
                                    <div class="left">
                                    <div class="left-deg red"></div>
                                    </div>
                                    <div class="right">
                                    <div class="right-deg red"></div>
                                    </div>
                                    <div class='num'><span class='nums'></span><strong class='small'>%</strong></div>
                                </div>
                            </div>
                            <div class='right-box'>
                                <div class='num'>65</div>
                                <div class='name'>待处理</div>
                            </div>
                        </li>
                    </ul>
                </div>
                <div class='street-detail-content'>
                    <div class='ul'>
                        <ul class='dot-table'>
                            <li class='dot-table-cell selected'>
                                <div class='dot-text'>全部</div>
                            </li>
                            <li class='dot-table-cell'>
                                <div class='dot-text'>待巡查</div>
                            </li>
                            <li class='dot-table-cell'>
                                <div class='dot-text'>处理中</div>
                            </li>
                            <li class='dot-table-cell'>
                                <div class='dot-text'>待处理</div>
                            </li>
                            <li class='dot-table-cell'>
                                <div class='dot-text'>已处理</div>
                            </li>
                            <li class='dot-table-cell'>
                                <div class='dot-text'>合格</div>
                            </li>
                        </ul>
                    </div>
                    <div class='dotList'>
                        <ul class='dotList-ul' id='streetDetailUl'>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- 统计详情 -->
            <div class='allDiv statis-detail blueBackBg hide'>
                <div class='close'>
                    <div class='icon'></div>
                </div>
                <div class='linebg lineBg-lt'></div>
                <div class='linebg lineBg-lb'></div>
                <div class='linebg lineBg-rt'></div>
                <div class='linebg lineBg-rb'></div>
                <div class='title' id='statisName'><span class='namess'>浦东新区</span>——巡查统计数据</div>
                <div class='content statis-content'>
                    <span class='items years'></span>
                    <span class='items items1'>合格率： <strong class='nos'></strong></span>
                    <span class='items items2 itemsBlock'>巡访点位：<strong class='nos'></strong></span>
                    <span class='items items3'>巡访率：<strong class='nos'></strong></span>
                    <span class='items items4'>整改率：<strong class='nos'></strong></span>
                    <span class='items items5'>待巡查点位：<strong class='nos'></strong></span>
                    <span class='items items6'>合格点位：<strong class='nos'></strong></span>
                    <span class='items items7'>问题点位：<strong class='nos'></strong></span>
                    <span class='items items8'>整改点位：<strong class='nos'></strong></span>
                    <span class='items items9'>巡访检查项：<strong class='nos'></strong></span>
                    <span class='items items10'>发现问题数：<strong class='nos'></strong></span>
                    <span class='items items11'>问题整改率：<strong class='nos'></strong></span>
                    <span class='items items12'>问题整改数：<strong class='nos'></strong></span>
                    <div class="borderLine float"></div>
                    <!--- 问题分布 --->
                    <div class='problem-cont'>
                        <div class='top-statis' id='topStatis'></div>
                        <ul class='statis-list'></ul>
                    </div>
                </div>
            </div>
            <!-- 点位详情 -->
            <div class='allDiv dot-detail blueBackBg hide'>
                <div class='close'>
                    <div class='icon'></div>
                </div>
                <div class='linebg lineBg-lt'></div>
                <div class='linebg lineBg-lb'></div>
                <div class='linebg lineBg-rt'></div>
                <div class='linebg lineBg-rb'></div>
                <div class='title'>点位详情</div>
                <div class='content'>
                    <div class='detail'>
                        <div class='left-cont'>
                            <div class='leftBox'><img class='img' src='' /></div>
                        </div>
                        <div class='right-cont'>
                            <div class='title'></div>
                            <div class='cont-box mans'>
                                <span class='icon-box userIcon'></span>
                                <span class='name'></span>
                                <span class='phone'></span>
                            </div>
                            <div class='cont-box adds'>
                                <span class='icon-box addressIcon'></span>
                                <span class='address'></span>
                            </div>
                            <div class='cont-box grids'>
                                <span class='icon-box gridIcon'></span>
                                <span class='address'></span>
                            </div>
                        </div>
                    </div>
                    <div class='content-table'>
                        <ul class='dot-table'>
                            <li class='dot-table-cell selected'>
                                <div class='dot-text'>巡查情况</div>
                            </li>
                            <li class='dot-table-cell'>
                                <div class='dot-text'>历史记录</div>
                            </li>
                            <li class='dot-table-cell'>
                                <div class='dot-text'>数据统计</div>
                            </li>
                        </ul>
                    </div>
                    <!--- 选项卡 --->
                    <div class='content-table-div'>
                        <!--巡查情况-->
                        <div class='cont'>
                            <div class='xuncha-detail'></div>
                            <div class='xuncha-list'>
                                <ul class="info" id='hasRules'></ul>
                            </div>
                        </div>
                        <!--历史数据-->
                        <div class='cont historyBox hide'>
                            <div class='history-th'>
                                <span class='time'>编号/时间</span>
                                <span class='man'>巡查员</span>
                                <span class='status'>结果/状态</span>
                            </div>
                            <ul class='history-list' id='historyList'></ul>
                        </div>
                        <!--数据统计-->
                        <div class='cont statis-pro hide'>
                            <div class='box'>
                                <div class='label'>月问题数据</div>
                                <div class='content' id='monthId'></div>
                            </div>
                            <div class='box'>
                                <div class='label'>问题分布</div>
                                <div class='content' id='problemId'></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 底部操作,指挥保障 按钮 -->
            <div class='allDiv allDiv2 bottom-table hide'>
                <div class='btn btm-btn1' id='messageIds'></div>
                <div class='btn btm-btn2'></div>
                <div class='btn btm-btn3'></div>
                <div class='btn btm-btn4'></div>
            </div>
            <!-- 聊天窗口 -->
            <div class='allDiv btmDiv chatBox blueBackBg hide'>
                <div class='close'>
                    <div class='icon'></div>
                </div>
                <div class='linebg lineBg-lt'></div>
                <div class='linebg lineBg-lb'></div>
                <div class='linebg lineBg-rt'></div>
                <div class='linebg lineBg-rb'></div>
                <div class='chat-content chatBg'>
                    <div class='chat-name'>和小喜哥的聊天</div>
                    <ul class="scroll-view-item chatOne" id='chatView'></ul>
                    <div class='chat-btm'>
                        <div class='top'>
                            <div class='imgbox'>
                                <image class='img' src='../images/imgs.png' />
                                <input type="file" id="uploadfile" class='file' />
                            </div>
                            <div class='text'>快捷语</div>
                            <div class='button' onClick="sendChat(0,'在我这里')">在我这里</div>
                            <div class='button' onClick="sendChat(0,'领导打车了')">领导打车了</div>
                        </div>
                        <div class='flex'>
                            <div class='imgBox' onClick="sendChat(2,1)">
                                <image class='img' src='../images/addre-white.png'></image>
                            </div>
                            <div class='cont'>
                                <textarea id='textarea1' rows='1' v-model="textVal" maxlength="5000" class='textarea' placeholder="输入"></textarea>
                            </div>
                            <div class='emjoy' onClick="sendChat(0,1)">
                                <img class='img' src='../images/send.png' />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 通讯录 -->
            <div class='allDiv btmDiv telbookBox blueBackBg hide'>
                <div class='close'>
                    <div class='icon'></div>
                </div>
                <div class='linebg lineBg-lt'></div>
                <div class='linebg lineBg-lb'></div>
                <div class='linebg lineBg-rt'></div>
                <div class='linebg lineBg-rb'></div>
                <div class='title'>全部联系人</div>
                <div class='underLineBg'>
                    <div class='bg'></div>
                </div>
                <div class='content'>
                    <div class='searchView'>
                        <img class='w-search-icon' src="../images/search.png" mode="" />
                        <input
                            type='text' 
                            class='w-search-text'
                            v-model="searchVal" 
                            confirm-type="search"
                            placeholder-class="phcolor" 
                            placeholder="搜索联系人"
                            @confirm="search" 
                        />
                    </div>
                    <ul class='message-content' id='telbookView'></ul>
                    <div class="message-no-data hide">
                        <div>暂无联系人！</div>
                    </div>
                </div>
            </div>
            <!-- 信号管理 -->
            <div class='allDiv btmDiv signal-Box blueBackBg hide'>
                <div class='close'>
                    <div class='icon'></div>
                </div>
                <div class='linebg lineBg-lt'></div>
                <div class='linebg lineBg-lb'></div>
                <div class='linebg lineBg-rt'></div>
                <div class='linebg lineBg-rb'></div>
                <div class='chat-content chatBg chatBg-signal'>
                    <ul class="scroll-view-item" id='signalView' style='bottom: 0;'></ul>
                </div>
            </div>
            <!-- 标记信号 -->
            <div class='allDiv btmDiv mark-Box blueBackBg hide'>
                <div class='linebg lineBg-lt'></div>
                <div class='linebg lineBg-lb'></div>
                <div class='linebg lineBg-rt'></div>
                <div class='linebg lineBg-rb'></div>
                <div class="content">
                    <div class='btm-btn-box'>
                        <span class='icon icon1'></span>
                        <span class='name'>地点信号</span>
                    </div>
                    <div class='alertBg-line'></div>
                    <div class='btm-btn-box'>
                        <span class='icon icon2'></span>
                        <span class='name'>巡查标记</span>
                    </div>
                </div>
            </div>
            <!--- 图片预览 --->
            <div class='allDiv BigimgBox hide blueBackBg'>
                <div class='close'>
                    <div class='icon'></div>
                </div>
                <div class='linebg lineBg-lt'></div>
                <div class='linebg lineBg-lb'></div>
                <div class='linebg lineBg-rt'></div>
                <div class='linebg lineBg-rb'></div>
                <div class='title'>图片预览</div>
                <div class='imgBox'>
                    <img class='img' src=''/>
                </div>
            </div>
            <!-- btn：地图搜索、地图控制 -->
            <div class='btm-center'>
                <div class='btn btm-btn5'></div>
                <div class='btn btm-btn6'></div>
                <div class='btn btm-btn7'></div>
            </div>

            <!--  地图搜索 content  -->
            <div class='allDiv mapSearch blueBackBg hide'>
                <div class='close'>
                    <div class='icon'></div>
                </div>
                <div class='linebg lineBg-lt'></div>
                <div class='linebg lineBg-lb'></div>
                <div class='linebg lineBg-rt'></div>
                <div class='linebg lineBg-rb'></div>
                <div class='content'>
                    <div class='searchView'>
                        <img class='w-search-icon' src="../images/search.png" mode="" />
                        <input
                            type='text' 
                            class='w-search-text'
                            v-model="searchVal" 
                            confirm-type="search"
                            placeholder-class="phcolor" 
                            placeholder="搜索联系人"
                            @confirm="search" 
                        />
                        <img class='w-search-close hide' src="../images/close2.png" mode="" />
                    </div>
                    <ul class='message-content searchCont hide' id='searchCont'></ul>
                    <div class="message-no-data hide">
                        <div>暂无搜索记录！</div>
                    </div>
                    <div id='historyCont' class='historyBox hide'>
                        <div class='history-top'>
                            <span class='titles'>历史搜索记录</span>
                            <span class='imgs' title="删除历史记录" onclick="deleHistory();">
                                <img src='../images/dele.png' class='img'/>
                            </span>
                        </div>
                        <ul class='message-content'></ul>
                    </div>
                </div>
            </div>

            <!--  地图控制  -->
            <div class='allDiv mapSetting blueBackBg hide'>
                <div class='close'>
                    <div class='icon'></div>
                </div>
                <div class='linebg lineBg-lt'></div>
                <div class='linebg lineBg-lb'></div>
                <div class='linebg lineBg-rt'></div>
                <div class='linebg lineBg-rb'></div>
                <div class='title'>
                    地图控制
                    <span class='small'>设置地图显示的图例</span>
                </div>
                <div class='underLineBg'>
                    <div class='bg'></div>
                </div>
                <div class='content'>
                    <div class='show-dot'>
                        <div class='titles hide'>点位性质</div>
                        <div class='dotsetBox hide'>
                            <div class="switch-box">
                                <div class='text'>日常点位</div>
                                <div class="bg_con">
                                    <input id="checked1" type="checkbox" class="switch" checked />
                                    <label class='label' for="checked1"></label>
                                </div>
                            </div>
                            <div class="switch-box">
                                <div class='text'>随机点位</div>
                                <div class="bg_con">
                                    <input id="checked2" type="checkbox" class="switch" checked />
                                    <label class='label' for="checked2"></label>
                                </div>
                            </div>
                        </div>
                        <div class='borderLine hide'></div>
                        <div class='titles'>点位状态</div>
                        <div class='dotsetBox'>
                            <div class="switch-box">
                                <div class='text'>待巡查</div>
                                <div class="bg_con">
                                    <input id="checked3" type="checkbox" class="switch" checked />
                                    <label class='label' for="checked3"></label>
                                </div>
                            </div>
                            <div class="switch-box">
                                <div class='text'>合格点位</div>
                                <div class="bg_con">
                                    <input id="checked4" type="checkbox" class="switch" checked />
                                    <label class='label' for="checked4"></label>
                                </div>
                            </div>
                        </div>
                        <div class='dotsetBox'>
                            <div class="switch-box">
                                <div class='text'>待处理</div>
                                <div class="bg_con">
                                    <input id="checked5" type="checkbox" class="switch" checked />
                                    <label class='label' for="checked5"></label>
                                </div>
                            </div>
                            <div class="switch-box">
                                <div class='text'>处理中</div>
                                <div class="bg_con">
                                    <input id="checked6" type="checkbox" class="switch" checked />
                                    <label class='label' for="checked6"></label>
                                </div>
                            </div>
                        </div>
                        <div class='dotsetBox'>
                            <div class="switch-box">
                                <div class='text'>已处理</div>
                                <div class="bg_con">
                                    <input id="checked7" type="checkbox" class="switch" checked />
                                    <label class='label' for="checked7"></label>
                                </div>
                            </div>
                            <div class="switch-box">
                            </div>
                        </div>
                        <div class='borderLine'></div>
                        <div class='titles'>地图人员</div>
                        <div class='dotsetBox'>
                            <div class="switch-box">
                                <div class='text'>巡查员</div>
                                <div class="bg_con">
                                    <input id="checked8" type="checkbox" class="switch" checked />
                                    <label class='label' for="checked8"></label>
                                </div>
                            </div>
                            <div class="switch-box">
                                <div class='text'>点位长</div>
                                <div class="bg_con">
                                    <input id="checked9" type="checkbox" class="switch" checked />
                                    <label class='label' for="checked9"></label>
                                </div>
                            </div>
                        </div>
                        <div class='dotsetBox'>
                            <div class="switch-box">
                                <div class='text'>网格员</div>
                                <div class="bg_con">
                                    <input id="checked10" type="checkbox" class="switch" checked />
                                    <label class='label' for="checked10"></label>
                                </div>
                            </div>
                            <div class="switch-box">
                                <div class='text'>管理员</div>
                                <div class="bg_con">
                                    <input id="checked11" type="checkbox" class="switch" checked />
                                    <label class='label' for="checked11"></label>
                                </div>
                            </div>
                        </div>
                        <div class='borderLine'></div>
                    </div>
                </div>
            </div>

            <!--  迎检信息 + 消息通知 + list  -->
            <div class='allDiv noticeList blueBackBg hide'>
                <div class='close'>
                    <div class='icon'></div>
                </div>
                <div class='linebg lineBg-lt'></div>
                <div class='linebg lineBg-lb'></div>
                <div class='linebg lineBg-rt'></div>
                <div class='linebg lineBg-rb'></div>
                <div class='topUl'>
                    <li class='active'>迎检信息</li>
                    <li>迎检通知</li>
                </div>
                <div class='addMessText'>添加信息</div>
                <div class='content'>
                    <div class='son'>
                        <div class='table-title'>
                            <span class='table-width1'>序号</span>
                            <span class='table-width2'>类型</span>
                            <span class='table-width3'>点位名称</span>
                            <span class='table-width4'>备注</span>
                        </div>
                        <div class='table-cont'>
                            <ul class='tableul' id='messList'></ul>
                        </div>
                    </div>
                    <div class='son hide' id='noticeListScroll'>
                        <ul class='ul' id='noticeList'></ul>
                    </div>
                    
                </div>
            </div>

            <!--  线路设置  -->
            <div class='allDiv lineSetting blueBackBg hide'>
                <div class='close'>
                    <div class='icon'></div>
                </div>
                <div class='linebg lineBg-lt'></div>
                <div class='linebg lineBg-lb'></div>
                <div class='linebg lineBg-rt'></div>
                <div class='linebg lineBg-rb'></div>
                <div class='title'>
                    线路设置
                    <span class='small'>请设置显示线路的参数</span>
                </div>
                <div class='underLineBg'>
                    <div class='bg'></div>
                </div>
                <div class='content'>
                    <div class='text'>请选择显示线路的定位数据来源</div>
                    <div class='times deviceChoose'>
                        <div class='time active'>微信小程序</div>
                        <div class='time'>专业定位设备</div>
                    </div>
                    <div class='text'>请选择显示线路的时间段</div>
                    <div class='times checktime'>
                        <div class='time active'>今天</div>
                        <div class='time'>昨天</div>
                        <div class='time'>自定义</div>
                        <input class='timeInput' id='dateSelect' placeholder="请选择时间" />
                    </div>
                    <div class='text'>请选择显示线路的颜色</div>
                    <div class='color-box'>
                        <span class='clBox active'>
                            <span class='colorBgs bg1'>1号</span>
                        </span>
                        <span class='clBox'>
                            <span class='colorBgs bg2'>2号</span>
                        </span>
                        <span class='clBox'>
                            <span class='colorBgs bg4'>3号</span>
                        </span>
                        <span class='clBox'>
                            <span class='colorBgs bg6'>4号</span>
                        </span>
                        <span class='clBox'>
                            <span class='colorBgs bg10'>5号</span>
                        </span>
                        <span class='clBox'>
                            <span class='colorBgs bg12'>6号</span>
                        </span>
                        <span class='clBox'>
                            <span class='colorBgs bg14'>7号</span>
                        </span>
                        <span class='clBox'>
                            <span class='colorBgs bg16'>8号</span>
                        </span>
                    </div>
                    <div class='bottom'>
                        <span class='btn cancle'>取消</span>
                        <span class='line'></span>
                        <span class='btn sure'>显示线路</span>
                    </div>
                </div>
            </div>

            <!--  新增检查点  -->
            <div class='allDiv addDots blueBackBg hide'>
                <div class='close'>
                    <div class='icon'></div>
                </div>
                <div class='linebg lineBg-lt'></div>
                <div class='linebg lineBg-lb'></div>
                <div class='linebg lineBg-rt'></div>
                <div class='linebg lineBg-rb'></div>
                <div class='title'>标记信息 </div>
                <div class='underLineBg'>
                    <div class='bg'></div>
                </div>
                <div class='content'>
                    <div class='addDot-box'>
                        <div class='box'>
                            <div class='titles'>点位名：</div>
                            <input class='timeInput' id='addDot-name' placeholder="请输入点位名称" />
                        </div>
                        <div class='box'>
                            <div class='titles'>检查项：</div>
                            <textarea class='textarea' id='addDot-inspect' placeholder="请输入检查信息" rows="4" ></textarea>
                        </div>
                        <div class='box'>
                            <div class='titles'>备注：</div>
                            <textarea class='textarea' id='addDot-remark' placeholder="请输入备注信息" rows="4" ></textarea>
                        </div>
                    </div>
                    <div class='bottom'>
                        <span class='btn cancle'> 取消 </span>
                        <span class='line'></span>
                        <span class='btn sure'> 确定 </span>
                    </div>
                </div>
            </div>

            <!--  修改检查点  -->
            <div class='allDiv editDots blueBackBg hide'>
                <div class='close'>
                    <div class='icon'></div>
                </div>
                <div class='linebg lineBg-lt'></div>
                <div class='linebg lineBg-lb'></div>
                <div class='linebg lineBg-rt'></div>
                <div class='linebg lineBg-rb'></div>
                <div class='title'>迎检标记信息 </div>
                <div class='underLineBg'>
                    <div class='bg'></div>
                </div>
                <div class='content'>
                    <div class='addDot-box'>
                        <div class='box'>
                            <div class='titles'>点位名：</div>
                            <input class='timeInput' id='addDot-name2' placeholder="请输入点位名称" />
                        </div>
                        <div class='box'>
                            <div class='titles'>检查项：</div>
                            <textarea class='textarea' id='addDot-inspect2' placeholder="请输入检查信息" rows="4" ></textarea>
                        </div>
                        <div class='box'>
                            <div class='titles'>备注：</div>
                            <textarea class='textarea' id='addDot-remark2' placeholder="请输入备注信息" rows="4" ></textarea>
                        </div>
                    </div>
                    <div class='bottom'>
                        <span class='btn cancle'> 取消 </span>
                        <span class='line'></span>
                        <span class='btn sure'> 确定 </span>
                    </div>
                </div>
            </div>

            <!--  新增迎检信息  -->
            <div class='allDiv addMess blueBackBg hide'>
                <div class='close'>
                    <div class='icon'></div>
                </div>
                <div class='linebg lineBg-lt'></div>
                <div class='linebg lineBg-lb'></div>
                <div class='linebg lineBg-rt'></div>
                <div class='linebg lineBg-rb'></div>
                <div class='title'>新增迎检信息 </div>
                <div class='underLineBg'>
                    <div class='bg'></div>
                </div>
                <div class='content'>
                    <div class='addDot-box'>
                        <div class='box'>
                            <div class='titles'>点位类型：</div>
                            <input class='timeInput' id='mess-type' placeholder="请输入" />
                        </div>
						<div class='box'>
                            <div class='titles'>点位名称：</div>
                            <input class='timeInput' id='mess-name' placeholder="请输入" />
                        </div>
                        <div class='box'>
                            <div class='titles'>备注：</div>
                            <textarea class='textarea' id='mess-remark' placeholder="请输入" rows="3" ></textarea>
                        </div>
                    </div>
                    <div class='bottom'>
                        <span class='btn cancle'> 取消 </span>
                        <span class='line'></span>
                        <span class='btn sure'> 确定 </span>
                    </div>
                </div>
            </div>

            <!--  修改迎检信息  -->
            <div class='allDiv editMess blueBackBg hide'>
                <div class='close'>
                    <div class='icon'></div>
                </div>
                <div class='linebg lineBg-lt'></div>
                <div class='linebg lineBg-lb'></div>
                <div class='linebg lineBg-rt'></div>
                <div class='linebg lineBg-rb'></div>
                <div class='title'>修改迎检信息 </div>
                <div class='underLineBg'>
                    <div class='bg'></div>
                </div>
                <div class='content'>
                    <div class='addDot-box'>
                        <div class='box'>
                            <div class='titles'>点位类型：</div>
                            <input class='timeInput' id='mess-type2' placeholder="请输入" />
                        </div>
						<div class='box'>
                            <div class='titles'>点位名称：</div>
                            <input class='timeInput' id='mess-name2' placeholder="请输入" />
                        </div>
                        <div class='box'>
                            <div class='titles'>备注：</div>
                            <textarea class='textarea' id='mess-remark2' placeholder="请输入" rows="3" ></textarea>
                        </div>
                    </div>
                    <div class='bottom'>
                        <span class='btn cancle'> 取消 </span>
                        <span class='line'></span>
                        <span class='btn sure'> 确定 </span>
                    </div>
                </div>
            </div>

        </div>
    </body>
    <script>
        let _timeInter = 15000; //地图间隔时间
        let _streetData;
        let _map;
        var oldAllData=[]; //原始的所有数据
        var _alldata=[]; //所有的地图-点位数据
        let _styles={};  //点位样式-对象
        let _details={}; //详情数据
        let _lat = 31.222050  //默认经纬度
        let _lng = 121.544790  //默认经纬度
        let _addLat = null;  //新增检查点-维度
        let _addLng = null;  //新增检查点-经度
        let _upMessId = null; //修改迎检信息id
        //员工信息
        let _employees={"id":"000000007186cf4d01718c1143ce10eb","avatar":"","code":null,"createId":null,"createTime":"2020-04-18 14:54:34","gender":null,"modId":null,"modTime":"2020-04-18 15:19:38","name":"蒋后喜","openId":"or5Aw5aKns7c18iK5wozb-PVDC2o","orgId":null,"phone":"18423013466","position":"开发人员","status":"2","lat":null,"lng":null,"offlineTime":"2020-04-18 17:31:56","onlineStatus":"0","onlineTime":"2020-04-18 17:31:27","checkPoints":null,"roles":null,"funs":null,"orgs":[{"id":"0000000071716d7c0171718e16a30006","createId":null,"createTime":"2020-04-13 11:21:10","modId":null,"modTime":"2020-04-13 11:21:10","orgCode":"1.1052.1","orgContacts":null,"orgContactsTel":null,"orgDescription":null,"orgLevel":3,"orgName":"技术公司","pid":"0000000071716dae0171718de9ea0002","children":null}],"pwd":null}
        let _employeeId = '000000007186cf4d01718c1143ce10eb' //员工id
        let messageGroup={}; //消息群组-信息
        let _chatId; //chatId-聊天池id
        let messageManList=[]; //自己的聊天记录-人员list
        let _messageList=[]; //消息列表-list
        let _isScroll=true; //滚动条上拉加载更多。
        let _isOne=true; //每次下拉，间隔时间
        let newTime=null; //最新一条消息时间 
        let _rows = 50; //一次下拉刷新条数
        let isSend = true;  //是否可以发送消息。阻止重复发送
        let _keys = 'VGNBZ-YUX66-E4KSV-M43JP-PTXQF-MYB2O'
        let _isClickMap = false; //是否允许地图点击事件-信号
        let _isAddDot = false; //是否允许新增检查点
        let _DotId = null;
        let _address=''; //地址
        var circlefun; //定义圆参数
        var circleData=[]; //圆数据
        var isOne=false;  //单个人聊天
        var chatName=''; //和谁聊天-名字
        let _isScrollNotice = true;  //消息通知记录-是否允许下拉
        let _noticeRow=1; //消息通知记录-页
        let _lineMan=null;  //在线人员list
        let _clearTimeLine=null;  //人员路线-实时更新
        let _showlineCenter=null;
        let _lineUser=[];  //多线路数据
        var socket; 
        var markerLayer;
        let imgList=[];
        let imgIndex=0;
        var _center;
        var _polylineLayer; //地图区域
        var _lineMap=null; //线路
        let _lineData=[]; // 当前人员-点击折线时，传递过来的数据
        let _weeksData=[]; //周期数据
        let _startTimeLine=null; //人员线路start    
        let _endTimeLine=null;   //人员线路end
        let _bgIndex = 0; //选中的第几个颜色
        let _bgcolor = ['#de2020','#f86600','#fee300','#6cd401','#2601ff','#b620e3','#a86e56','#7e2841']; //线条颜色
        let _endTimes=''
        let _statisDataStreet = []; //统计数据-街道
        let _statisDataOrg = []; //统计数据-单位
        let _orgId=null; //选中的单位id
        /*地图控制，所有数据id备份、赛选*/
        let _dataRole1 = []  //巡查员
        let _dataRole2 = []  //点位长
        let _dataRole3 = []  //网格员
        let _dataRole4 = []  //信号
        let _dataAdmin = []  //管理员
        let _dataType1=[]  //日常点位
        let _dataType2=[]  //随机点位
        let _dataStaus1 = []  //待巡查
        let _dataStaus2 = []  //合格点位
        let _dataStaus3 = []  //待处理
        let _dataStaus4 = []  //处理中
        let _dataStaus5 = []  //已处理
        //地图控制人员开关，关了的，就不显示人员
        let _isShowRole1 = true
        let _isShowRole2 = true
        let _isShowRole3 = true
        let _isShowRole4 = true
        //该人员是否绑定专业定位设备.
        let _hasDevice = false
        let _linetype = 1
        //查询设备code
        let _deviceCode = null  

        /*街镇排名，条件*/
        let _streetRole_area = 0     //街镇、单位、地区、
        let _streetRole_random = -1   //全部、日常、随机
        let _streetRole_term = 0     //条件下拉
        let _noticeSys = false  //系统配置是否显示
        let _areaChoose=null   //选中的哪一个街镇
        let _areaChooseData=null  //选中街镇的数据

        $(document).ready(function(){
            //首先获取地图配置，间隔时间
            let _setUrl = $.config.apiUrl+'/watchEvent/loadCfg';
            let setData={}
            setData.cfgCode = 'SCREEN.ONLINE.USER.interval'
            $.ajax({
                url: _setUrl,
                type: "POST",
                data: JSON.stringify(setData),
                contentType: "application/json",
                dataType: "json",
                async: false,
                success: function(data){
                    if(data.code==200&&data.data!==null&&data.data.cfgValue!==null){
                        _timeInter = parseInt(data.data.cfgValue) * 1000;
                    }
                }
            })

            $('#dateSelect').focus(function(){
				$('#dateSelect').daterangepicker({
					timePicker: true,
					timePickerIncrement: 1,
					timePicker12Hour : false,
					timePicker24Hour : true,
					maxDate : moment(),
					locale: {
						format: "YYYY-MM-DD HH:mm:ss",
						separator: " - ",
						daysOfWeek: ["日","一","二","三","四","五","六"],
						monthNames: ["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"]
					}
				},function(start, end,label) {
					let _start = moment(start).format('YYYY-MM-DD HH:mm:ss')
					let _end = moment(end).format('YYYY-MM-DD HH:mm:ss')
					_startTimeLine = _start
					_endTimeLine = _end
					setTimeout(() => {
						$('#dateSelect').val(_startTimeLine+' - ' + _endTimeLine)
					}, 1);
					return false
				})
			})
            //时间下拉
            /**/
            $('#dateSelect').val('')

            /*颜色选择*/
            $(document).on('click','.lineSetting .color-box>.clBox',function(){
                let _index = $(this).index()
                $(this).addClass('active').siblings().removeClass('active')
                let _color = $(this).find('.colorBgs').css('background-color');
                _bgIndex = _index
            })

            /*切换设备，小程序，专业定位设备*/
            $(document).on('click','.lineSetting .times.deviceChoose>.time',function(){
                let _index = $(this).index()
                $(this).addClass('active').siblings().removeClass('active')
                _linetype = _index+1;
            });

            /* 显示人员路线 */
            $(document).on('click','.lineSetting .times.checktime>.time',function(){
                let _index = $(this).index()
                $(this).addClass('active').siblings().removeClass('active')
                if(_index==0){
                    _startTimeLine = $.config.todayStart()
                    _endTimeLine = $.config.todayEnd()
                    //今天
                    $('#dateSelect').val(_startTimeLine+' - ' + _endTimeLine)
                }else if(_index==1){
                    _startTimeLine = $.config.yestodayStart()
                    _endTimeLine = $.config.yestodayEnd()
                    //昨天
                    $('#dateSelect').val(_startTimeLine+' - ' + _endTimeLine)
                }
            })

            //关闭线路-弹窗
            $(document).on('click','.lineSetting .bottom .cancle',function(){
                $('.lineSetting').addClass('hide')
            })

            //显示线路轨迹
            $(document).on('click','.lineSetting .bottom .sure',function(){
                //定义多线路数据
                let _ars = {}
                _ars.employeeId = _lineData.employeeId
                _ars.startTime = _startTimeLine  //开始时间
                _ars.endTime = _endTimeLine  //结束时间
                _ars.index = _bgIndex  //第几个颜色
                _ars.phone = _lineData.employeePhone  //电话-唯一
                _ars.isone = null  //第一次 / 更新
                _ars.startLat=null  
                _ars.startLng=null
                _ars.endLat=null
                _ars.endLng=null
                _ars.interval = 'setInter_' + _lineData.employeePhone  //循环事件-定时任务
                let _fla = false
                let _k;
                for(let i=0; i<_lineUser.length; i++){
                    if(_lineData.employeeId == _lineUser[i].employeeId){
                        _fla = true
                        _k = i
                        break
                    }
                }
                if(!_fla){
                    _lineUser.push(_ars)
                }else{
                    //也要清理一次原来的定时任务
                    closeLine(_lineData)
                    _lineUser[_k] = _ars
                }
                //get折线数据
                showLine(_ars,_linetype)
                $('.lineSetting').addClass('hide')
                //定时任务
                _ars.interval = null
                _ars.interval = setInterval(() => {
                    showLine(_ars,_linetype)
                }, _timeInter);
            })

            //关闭弹窗
            $(document).on('click','.addDots .bottom .cancle',function(){
                $('.addDots').addClass('hide')
                _isAddDot = false
            })

            //关闭弹窗
            $(document).on('click','.editDots .bottom .cancle',function(){
                $('.editDots').addClass('hide')
                _isAddDot = false
            })

            //提交-检查点
            $(document).on('click','.addDots .bottom .sure',function(){
                _isAddDot = false
                let _name = $('#addDot-name').val() 
                let _inspect = $('#addDot-inspect').val() 
                let _remark = $('#addDot-remark').val() 
				if(_name==''){
					alert('请录入点位名称!')
					return false
				}
                let _ars={}
                _ars.pointName = _name 
                _ars.roundPoint = 1
                let _man = {}
                _man.types=9
                _man.remarks = _remark
                _man.inspect = _inspect
                _ars.subsidiary = JSON.stringify(_man)
                _ars.pointType = -1
                _ars.dimension = _addLat
                _ars.longitude = _addLng
                let _mapJson = {"latitude":_addLat,"longitude":_addLng}
                _ars.mapJson = JSON.stringify(_mapJson)
                let _url = $.config.apiUrl+'/checkpoint/save';
                $.ajax({
                    url: _url,
                    data: JSON.stringify(_ars),
                    type: "POST",
                    contentType: "application/json",
                    dataType: "json",
                    async: false,
                    success: function(data){
                        if(data.code==200){
                            $.messageTip.success({
                                message:"新增成功...",
                                fadeInTimeOut : 1,   //滑入秒数
                                contentTimeOut : 3,  //内容停留秒数 
                                fadeOutTimeOut : 1, ////滑出秒数
                            });
                            let _ar={}
                            _ar.id = data.data.pointId
                            _ar.styleId = 'styleMark'
                            _ar.position = new TMap.LatLng(data.data.dimension, data.data.longitude)
                            _ar.properties= data.data
                            _ar.properties.type = 'styleMark' //类型，点位
                            markerLayer.add(_ar)
                        }
                    }
                })
                $('.addDots').addClass('hide') 
            })

            //提交-检查点修改
            $(document).on('click','.editDots .bottom .sure',function(){
                _isAddDot = false
                let _name = $('#addDot-name2').val() 
                let _inspect = $('#addDot-inspect2').val() 
                let _remark = $('#addDot-remark2').val() 
				if(_name==''){
					alert('请录入点位名称!')
					return false
				}
                let _ars={}
                _ars.pointId = _DotId
                _ars.pointName = _name 
                _ars.roundPoint = 1
                let _man = {}
                _man.types=9
                _man.remarks = _remark
                _man.inspect = _inspect
                _ars.subsidiary = JSON.stringify(_man)
                _ars.pointType = -1
                let _url = $.config.apiUrl+'/checkpoint/save';
                $.ajax({
                    url: _url,
                    data: JSON.stringify(_ars),
                    type: "POST",
                    contentType: "application/json",
                    dataType: "json",
                    async: false,
                    success: function(data){
                        if(data.code==200){
                            $.messageTip.success({
                                message:"修改成功...",
                                fadeInTimeOut : 1,   //滑入秒数
                                contentTimeOut : 3,  //内容停留秒数 
                                fadeOutTimeOut : 1, ////滑出秒数
                            });
                            markerLayer.remove(data.data.pointId)
                            let _ar={}
                            _ar.id = data.data.pointId
                            _ar.styleId = 'styleMark'
                            _ar.position = new TMap.LatLng(data.data.dimension, data.data.longitude)
                            _ar.properties= data.data
                            _ar.properties.type = 'styleMark' //类型，点位
                            markerLayer.add(_ar)
                        }
                    }
                })
                $('.editDots').addClass('hide') 
            })

            //迎检信息-关闭弹窗
            $(document).on('click','.addMess .bottom .cancle',function(){
                $('.addMess').addClass('hide')
            })

             //迎检信息-关闭弹窗
             $(document).on('click','.editMess .bottom .cancle',function(){
                $('.editMess').addClass('hide')
            })

            //新增迎检信息-开启弹窗
            $(document).on('click','.noticeList .addMessText',function(){
                $('.addMess').removeClass('hide')
                $('.noticeList').addClass('hide')
                let _name = $('#mess-name').val('') 
                let _type = $('#mess-type').val('') 
                let _info = $('#mess-info').val('') 
                let _remark = $('#mess-remark').val('') 
            })

            //提交-迎检信息-新增
            $(document).on('click','.addMess .bottom .sure',function(){
                let _name = $('#mess-name').val() 
                let _type = $('#mess-type').val() 
                let _remark = $('#mess-remark').val() 
                let _ars={}
                _ars.checkPoint = _name 
                _ars.checkItem = _type 
                _ars.checkText = '1' 
                _ars.remarks = _remark
                _ars.createId = _employeeId
                let _url = $.config.apiUrl+'/checkInfo/save';
                $.ajax({
                    url: _url,
                    data: JSON.stringify(_ars),
                    type: "POST",
                    contentType: "application/json",
                    dataType: "json",
                    async: false,
                    success: function(data){
                        if(data.code==200){
                            $.messageTip.success({
                                message:"新增成功...",
                                fadeInTimeOut : 1,   //滑入秒数
                                contentTimeOut : 3,  //内容停留秒数 
                                fadeOutTimeOut : 1, ////滑出秒数
                            });
                        }
                    }
                })
                $('.addMess').addClass('hide') 
            })

            //提交-迎检信息-修改
            $(document).on('click','.editMess .bottom .sure',function(){
                let _name = $('#mess-name2').val() 
                let _type = $('#mess-type2').val() 
                let _remark = $('#mess-remark2').val() 
                let _ars={}
                _ars.infoId = _upMessId
                _ars.checkPoint = _name 
                _ars.checkItem = _type 
                _ars.checkText = '1' 
                _ars.remarks = _remark
                _ars.createId = _employeeId
                let _url = $.config.apiUrl+'/checkInfo/save';
                $.ajax({
                    url: _url,
                    data: JSON.stringify(_ars),
                    type: "POST",
                    contentType: "application/json",
                    dataType: "json",
                    async: false,
                    success: function(data){
                        if(data.code==200){
                            $.messageTip.success({
                                message:"修改成功...",
                                fadeInTimeOut : 1,   //滑入秒数
                                contentTimeOut : 3,  //内容停留秒数 
                                fadeOutTimeOut : 1, ////滑出秒数
                            });
                        }
                    }
                })
                $('.editMess').addClass('hide') 
            })

            /*添加角色、信号图标样式*/
            //巡查员
            _styles.styleRole1 = new TMap.MarkerStyle({"width": 48, "height": 48, "src": '../images/role2.png', "anchor": { x: 24, y: 24}})
            _styles.styleRole1_y = new TMap.MarkerStyle({"width": 48, "height": 48, "src": '../images/role2-y.png', "anchor": { x: 24, y: 24}})
            _styles.styleRole1_n = new TMap.MarkerStyle({"width": 48, "height": 48, "src": '../images/role2-n.png', "anchor": { x: 24, y: 24}})
            //点位长
            _styles.styleRole2 = new TMap.MarkerStyle({"width": 48, "height": 48, "src": '../images/role.png', "anchor": { x:24, y: 24 }})
            _styles.styleRole2_y = new TMap.MarkerStyle({"width": 48, "height": 48, "src": '../images/role-y.png', "anchor": { x:24, y: 24 }})
            _styles.styleRole2_n = new TMap.MarkerStyle({"width": 48, "height": 48, "src": '../images/role-n.png', "anchor": { x:24, y: 24 }})
            //网格员
            _styles.styleRole3 = new TMap.MarkerStyle({"width": 48, "height": 48, "src": '../images/role3.png', "anchor": { x: 24, y: 24 }})
            _styles.styleRole3_y = new TMap.MarkerStyle({"width": 48, "height": 48, "src": '../images/role3-y.png', "anchor": { x: 24, y: 24 }})
            _styles.styleRole3_n = new TMap.MarkerStyle({"width": 48, "height": 48, "src": '../images/role3-n.png', "anchor": { x: 24, y: 24 }})
            //信号
            _styles.styleRole4 = new TMap.MarkerStyle({"width": 48, "height": 48, "src": '../images/icon-signal-covers.png', "anchor": { x: 24, y: 24 }})
            //管理员
            _styles.styleAdmin = new TMap.MarkerStyle({"width": 48, "height": 48, "src": '../images/admin.png', "anchor": { x: 24, y: 24}})
            _styles.styleAdmin_y = new TMap.MarkerStyle({"width": 48, "height": 48, "src": '../images/admin-y.png', "anchor": { x: 24, y: 24}})
            _styles.styleAdmin_n = new TMap.MarkerStyle({"width": 48, "height": 48, "src": '../images/admin-n.png', "anchor": { x: 24, y: 24}})
            //信号
            _styles.styleMark = new TMap.MarkerStyle({"width": 60, "height": 60, "src": '../images/role4.png', "anchor": { x: 30, y: 30 }})

            //设置线路的icon
            for(let i=1; i<8; i++){
                let _names='lines'+i
                let _src = '../images/line'+i+'.png'
                _styles[_names] = new TMap.MarkerStyle({"width": 54, "height": 54, "src": _src, "anchor": { x: 27, y: 27}})
            }

            //let  _width = $('.maxBg .topBg').width()
            //if(_width>3000){
                //$('.maxBg').width(5040)
                /*$('.maxBg .topBg').addClass('topBg2')
                $('.titleBlue').addClass('hide')
                $('.mess-statis .statis-right').addClass('statis-right2')
                $('.mess-statis .statis-left').addClass('statis-left2')
                $('.mess-statis .Patrol2').removeClass('hide')*/
            //}
            
            //初始化用户数据
            getUserInfo()
            //初始化地图  
            _center = new TMap.LatLng(_lat, _lng);//设置中心点坐标
            _map = new TMap.Map(document.getElementById("container"), {
                center: _center,  
                zoom: 14, //设置缩放级别
                mapStyleId: 'style1',
                draggable : true, //设置是否可以拖拽
                scrollwheel : false, //设置是否可以滚动
                disableDoubleClickZoom : false, //设置是否可以双击放大 
            });
            //改变+-操作地图位置
            $(".zoom-control").parent().addClass('zoom-control-box');
            //绑定点击事件
            _map.on("click",function(evt){
                let _lat2 = evt.latLng.getLat().toFixed(6);
                let _lng2 = evt.latLng.getLng().toFixed(6);
                //点击地图，添加信号
                if(_isClickMap==true){
                    _isClickMap = false
                    $("#container").css("cursor","");
                    //发信号
                    let _data={"lat":_lat2,"lng":_lng2}
                    sendSignal(_data)
                }

                //新增巡查点 
                if(_isAddDot == true){
                    _isAddDot = false
                    _addLat = _lat2
                    _addLng = _lng2
                    $("#container").css("cursor","");
                    $('.addDots').removeClass('hide')
                    //值清零
                    $('#addDot-name').val('')
                    $('#addDot-inspect').val('')
                    $('#addDot-remark').val('')
                }
            })

            //得到点位数据
            getAlldot()

            //初始化获取事件
            getEventList()

            //实时更新，在线人员,获取周边在线人员
            getLineUser()
            setInterval(() => {
                getLineUser()
            }, _timeInter);

            //markerLayer.remove(["1","4"]) -删除只定id的标注
            //清空所有标注 markerLayer.setGeometries([])
            //显示多个点位
            markerLayer = new TMap.MultiMarker({
                id: 'marker-layer',
                map: _map,  //指定地图容器
                //样式定义
                styles: _styles,
                enableDefaultStyle: true,   //使用默认样式
                //minimumClusterSize: 2,  //最小聚合点数：2个
                zoomOnClick: true,  //点击聚合数字放大展开
                gridSize: 60,       //聚合算法的可聚合距离，即距离小于该值的点会聚合至一起，默认为60，以像素为单位
                averageCenter: false, //每个聚和簇的中心是否应该是聚类中所有标记的平均值
                //maxZoom: 16, //采用聚合策略的最大缩放级别，若地图缩放级别大于该值，则不进行聚合，标点将全部被展开
                //点标记数据数组
                geometries: _alldata
            });

            //初始化infoWindow
            var infoWindow = new TMap.InfoWindow({
                map: _map,
                position: new TMap.LatLng(39.984104,116.307503),
                content: "",
                offset: { x: 0, y: -44 } //设置信息窗相对position偏移像素，为了使其显示在Marker的上方
            });
            infoWindow.close();//初始关闭信息窗关闭

            //定义圆
            circlefun = new TMap.MultiCircle({
                id: 'marker-circle',
                map: _map,  //指定地图容器
                zIndex: 99999,
                styles: {
                    'circle': new TMap.CircleStyle({
                        'color':'rgba(255, 111, 97,0.2)',
                        'showBorder': true,
                        'borderColor': '#FF6F61',
                        'borderWidth': 2,
                    }),
                },
                geometries: circleData
            })

            //地图点位点击事件-响应变化
            var clickHandler = function (evt) {

                //自定义弹窗
                let _datas = evt.geometry.properties
                let _datas2 = evt.geometry

                if(_datas.type=='lines'){
                    return false
                }
                infoWindow.open(); //打开信息窗
                infoWindow.setPosition(evt.geometry.position);//设置信息窗位置
                $('.alertBg2').show()
                $('.alertArrorBg').show()
                //修改，点击的放大
                if(_datas.type=='dot'){
                    //点位 -详情
                    _details = _datas
                    let _imgs = setImgs2(_datas)
                    let _status = getStatus(_datas)
                    let _class = ''
                    if(_status=='a'){
                        _class = 'redBg'
                    }else if(_status=='b'){
                        _class = 'blueBg'
                    }else if(_status=='c'){
                        _class = 'greenBg'
                    }else if(_status=='d'){
                        _class = 'orangeBg'
                    }else if(_status=='f'){
                        _class = 'yellowBg'
                    }
                    let _nams =  ''
                    if(_datas.contactName!==null){
                        _nams = "<div class='cont-box'>"+
                                                "<span class='icon-box userIcon'></span>"+
                                                "<span class='name'>"+_datas.contactName+"</span>"+
                                                "<span class='phone'>"+_datas.contactTel+"</span>"+
                                            "</div>";
                    }
                    let _content = "<div class='alertBg'>"+
                                    "<div class='linebg lineBg-lt'></div>"+
                                    "<div class='linebg lineBg-lb'></div>"+
                                    "<div class='linebg lineBg-rt'></div>"+
                                    "<div class='linebg lineBg-rb'></div>"+
                                    "<div class='alertBg-top'>"+
                                        "<div class='left-cont'>"+
                                            "<div class='leftBox "+_class+"'><img class='img' src='"+_imgs+"' /></div>"+
                                        "</div>"+
                                        "<div class='right-cont'>"+
                                            "<div class='title'>"+_datas.pointName+"</div>"+
                                            _nams+
                                            "<div class='cont-box'>"+
                                                "<span class='icon-box addressIcon'></span>"+
                                                "<span class='address'>"+_datas.pointAddress+"</span>"+
                                            "</div>"+
                                            "<div class='cont-box'>"+
                                                "<span class='icon-box gridIcon'></span>"+
                                                "<span class='address'>上级管理："+_datas.ascription+"</span>"+
                                            "</div>"+
                                        "</div>"+
                                    "</div>"+
                                    "<div class='alertBg-btm'>"+
                                        "<div class='btm-btn-box' onclick='dotDetailClick("+JSON.stringify(_datas)+",1);'>"+
                                            "<span class='name'>查看详情</span>"+
                                        "</div>"+
                                    "</div>"+
                                "</div>"
                    infoWindow.setContent(_content);//设置信息窗内容
                    //给地图添加元素
                    $(".alertBg").parent().addClass('alertBg2');
                    $(".alertBg").parent().next().addClass('alertArrorBg');
                }else if(_datas.type=='employee'){
                    //人员
                    //判断是否有专业定位设备，是否在线
                    let _loadding=''
                    if(_datas.equCode!==null){
                        _deviceCode = _datas.equCode
                        //查询设备信息
                        getDeviceDetail(_deviceCode)
                        _loadding = '<image class="imgs deviceLoadding" src="../images/loadding.gif" style="width: 32px; height: 32px;"/>';
                    }
                    let _status = _datas.roleCode
                    let _class = ''
                    if(_status=='dotRole'){
                        //点位长
                        _class = 'dotRoleBg'
                        _imgs = '../images/icon2-w.png'
                    }else if(_status=='dotGrid'){
                        //网格员
                        _class = 'dotGridBg'
                        _imgs = '../images/icon3-w.png'
                    }else if(_status=='dotPatrolHas'||_status=='dotPatrolNo'){
                        //巡查员
                        _class = 'dotPatrolBg'
                        _imgs = '../images/icon1-w.png'
                    }else if(_status=='sysadmin'){
                        //系统管理员
                        _class = 'adminBg'
                        _imgs = '../images/admin-white.png'
                    }
                    //查询机构
                    let _employeesData = queryEmployee(_datas.employeeId)
                    let _orgs = getEmployeeOrg(_employeesData)
                    let _content = "<div class='alertBg'>"+
                                    "<div class='linebg lineBg-lt'></div>"+
                                    "<div class='linebg lineBg-lb'></div>"+
                                    "<div class='linebg lineBg-rt'></div>"+
                                    "<div class='linebg lineBg-rb'></div>"+
                                    "<div class='alertBg-top' style='border:0'>"+
                                        "<div class='left-cont'>"+
                                            "<div class='leftBox "+_class+"'><img class='img' src='"+_imgs+"' /></div>"+
                                        "</div>"+
                                        "<div class='right-cont' style='min-width: 200px'>"+
                                            "<div class='title'><div class='leftName'>"+_datas.employeeName+"</div><div class='rightOrg'>"+_orgs+"</div></div>"+
                                            "<div class='cont-box'>"+
                                                "<span class='phone' style='margin-left:0'>"+_datas.employeePhone+"</span>"+
                                            "</div>"+
                                            "<div class='cont-box'>"+
                                                "<span class='address'>"+_datas.roleName+"</span>"+
                                            "</div>"+
                                        "</div>"+
                                    "</div>"+
                                    _loadding+
                                    "<div class='deviceshow hide' id='deviceshow'>"+
                                        "<img class='deviceLeft' src='../images/device-green.png' />"+
                                        "<ul class='deviceRight'>"+
                                            "<li class='wd'>"+
                                                "<span class='name'></span>"+
                                                "<span class='time'></span>"+
                                            "</li>"+
                                            "<li class='xl'>"+
                                                "<span class='name'></span>"+
                                                "<span class='time'></span>"+
                                            "</li>"+
                                            "<li class='bs'>"+
                                                "<span class='name'></span>"+
                                                "<span class='time'></span>"+
                                            "</li>"+
                                        "</ul>"+
                                    "</div>"+
                                    "<div class='deviceshow hide' id='deviceNo'>"+
                                        "<img class='deviceLeft' src='../images/device-gray.png' />"+
                                        "<ul class='deviceRight'>设备离线</ul>"+
                                    "</div>"+
                                    "<div class='alertBg-btm'>"+
                                        "<div class='btm-btn-box' onClick='chatOne("+JSON.stringify(_datas.employeeId)+','+JSON.stringify(_datas.employeeName)+");'>"+
                                            "<span class='icon iconMess'></span>"+
                                            "<span class='name'>发送消息</span>"+
                                        "</div>"+
                                        "<div class='alertBg-line'></div>"+
                                        "<div class='btm-btn-box' onclick='sendSignal("+JSON.stringify(_datas)+");'>"+
                                            "<span class='icon iconMark'></span>"+
                                            "<span class='name'>标记信号</span>"+
                                        "</div>"+
                                    "</div>"+
                                    "<div class='alertBg-btm'>"+
                                        "<div class='btm-btn-box' onclick='showLineBox("+JSON.stringify(_datas)+");'>"+
                                            "<span class='icon iconSignal'></span>"+
                                            "<span class='name'>显示线路</span>"+
                                        "</div>"+
                                        "<div class='alertBg-line'></div>"+
                                        "<div class='btm-btn-box' onclick='closeLine("+JSON.stringify(_datas)+");'>"+
                                            "<span class='icon iconSignal'></span>"+
                                            "<span class='name'>隐藏线路</span>"+
                                        "</div>"+
                                    "</div>"+
                                "</div>"
                    infoWindow.setContent(_content);//设置信息窗内容
                    //给地图添加元素
                    $(".alertBg").parent().addClass('alertBg2');
                    $(".alertBg").parent().next().addClass('alertArrorBg');
                }else if(_datas.type=='signal'){
                    //信号
                    //查询机构
                    let _employeesData = queryEmployee(_datas.employeeId)
                    let _orgs = getEmployeeOrg(_employeesData)
                    let _status = _datas.roleCode
                    let _class = 'redBg'
                    _imgs = '../images/icon-signal-white.png'
                    let _content = "<div class='alertBg'>"+
                                    "<div class='linebg lineBg-lt'></div>"+
                                    "<div class='linebg lineBg-lb'></div>"+
                                    "<div class='linebg lineBg-rt'></div>"+
                                    "<div class='linebg lineBg-rb'></div>"+
                                    "<div class='alertBg-top'>"+
                                        "<div class='left-cont'>"+
                                            "<div class='leftBox "+_class+"'><img class='img' src='"+_imgs+"' /></div>"+
                                        "</div>"+
                                        "<div class='right-cont' style='min-width: 200px'>"+
                                            "<div class='title'>"+_datas.name+"</div>"+
                                            "<div class='cont-box'>"+
                                                "<span class='address'>"+_orgs+"</span>"+
                                            "</div>"+
                                            "<div class='cont-box'>"+
                                                "<span class='phone noLeft'>"+_datas.phone+"</span>"+
                                            "</div>"+
                                            "<div class='cont-box'>"+
                                                "<span class='address'>"+_datas2.eventTime+"</span>"+
                                            "</div>"+
                                        "</div>"+
                                    "</div>"+
                                    "<div class='alertBg-btm'>"+
                                        "<div class='btm-btn-box' onclick='cancleSignal("+JSON.stringify(_datas2)+','+'1'+");'>"+
                                            "<span class='icon iconMessClose'></span>"+
                                            "<span class='name'>关闭信号</span>"+
                                        "</div>"+
                                        "<div class='alertBg-line'></div>"+
                                        "<div class='btm-btn-box'>"+
                                            "<span class='icon iconSignal'></span>"+
                                            "<span class='name'>信号提醒</span>"+
                                        "</div>"+
                                    "</div>"+
                                "</div>"
                    infoWindow.setContent(_content);//设置信息窗内容
                    //给地图添加元素
                    $(".alertBg").parent().addClass('alertBg2');
                    $(".alertBg").parent().next().addClass('alertArrorBg');
                }else if(_datas.type=='styleMark'){
                    let _shows = JSON.parse(_datas.subsidiary)
                    //巡检标记
                    //查询机构
                    let _content = "<div class='alertBg'>"+
                                    "<div class='linebg lineBg-lt'></div>"+
                                    "<div class='linebg lineBg-lb'></div>"+
                                    "<div class='linebg lineBg-rt'></div>"+
                                    "<div class='linebg lineBg-rb'></div>"+
                                    "<div class='alertBg-top'>"+
                                        "<div class='left-cont'>"+
                                            "<div class='leftBox greenbg'><img class='img' src='../images/mark-white.png' /></div>"+
                                        "</div>"+
                                        "<div class='right-cont' style='min-width: 200px'>"+
                                            "<div class='title'><div class='leftName small'>检查点位：</div></div>"+
                                            "<div class='title'><div class='leftName'>"+_datas.pointName+"</div></div>"+
                                            "<div class='cont-box nos'>"+
                                                "<span class='phone white' style='margin-left:0'>检查项：</span>"+
                                                "<div class='shows'>"+_shows.inspect+"</div>"+
                                                "<div class='shows'>备注："+_shows.remarks+"</div>"+
                                            "</div>"+
                                        "</div>"+
                                    "</div>"+
                                    "<div class='alertBg-btm'>"+
                                        "<div class='btm-btn-box' onClick='updateDots("+JSON.stringify(_datas)+");'>"+
                                            "<span class='icon update'></span>"+
                                            "<span class='name'>修改信息</span>"+
                                        "</div>"+
                                        "<div class='alertBg-line'></div>"+
                                        "<div class='btm-btn-box' onclick='delDots("+JSON.stringify(_datas.pointId)+");'>"+
                                            "<span class='icon delete'></span>"+
                                            "<span class='name'>删除标记</span>"+
                                        "</div>"+
                                    "</div>"+
                                "</div>"
                    infoWindow.setContent(_content);//设置信息窗内容
                    //给地图添加元素
                    $(".alertBg").parent().addClass('alertBg2');
                    $(".alertBg").parent().next().addClass('alertArrorBg');
                }

                
            }
            //监听marker点击事件
            markerLayer.on("click", clickHandler)
            
            //解绑点击事件，要求事件处理方法不能是匿名方法
            function eventOff(){
                markerLayer.off("click", clickHandler)
            }

            /* 街镇统计排名-条件赛选 --街镇、地区、单位 */
            $(document).on('click','.allDiv .titleBox>span',function(){
                let _index = $(this).index()
                $(this).addClass('active').siblings().removeClass('active')
                _streetRole_area = _index
                streetStatis(_index,_streetRole_random,_streetRole_term)
            })

            /* 街镇统计排名-条件赛选 --全部、日常、随机 */
            $(document).on('click','.allDiv .titleBoxChoose .left>span',function(){
                let _index = $(this).index()
                $(this).addClass('active').siblings().removeClass('active')
                if(_index==0){
                    _streetRole_random = -1
                    streetStatis(_streetRole_area,-1,_streetRole_term)
                }else if(_index==1){
                    _streetRole_random = 0
                    streetStatis(_streetRole_area,0,_streetRole_term)
                }else if(_index==2){
                    _streetRole_random = 1
                    streetStatis(_streetRole_area,1,_streetRole_term)
                }
            })
            
            /*左侧选项卡点击事件*/
            $(document).on('click','.leftBtn>div',function(){
                $("#container").css("cursor","");
                _isClickMap = false
                _isAddDot = false
                let _index=$(this).index()
                $(this).addClass('active').siblings().removeClass('active')
                //隐藏其他
                $('.allDiv').addClass('hide')
                if(_index==0){
                    //综合信息
                    $('.mess-statis').removeClass('hide')
                    //综合信息-问题统计
                    problemStatis(0)
                }else if(_index==2){
                    //指挥保障
                    $('.bottom-table').removeClass('hide')
                    
                }else if(_index==1){
                    //日常保障
                    $('.dot-statis').removeClass('hide')
                    $('.street-statis').removeClass('hide')
                    _areaChoose=null
                    //街镇排名
                    problemStatis(1)
                    streetStatis(_streetRole_area,_streetRole_random,_streetRole_term)
                    
                }
                //移除区域
                if(_areaChoose!==null){
                    removeArea(_areaChooseData,_areaChoose)
                    _areaChoose=null
                    _areaChooseData=null
                }
                
            })

            /*指挥保障 底部点击事件*/
            $(document).on('click','.bottom-table>div',function(){
                $("#container").css("cursor","");
                _isClickMap = false
                _isAddDot = false
                let _index=$(this).index()
                $(this).addClass('active').siblings().removeClass('active')
                //隐藏其他
                $('.btmDiv').addClass('hide')
                if(_index==0){
                    //消息
                    $('.chatBox').removeClass('hide')
                    _messageList=[]
                    //显示群组
                    _isScroll=true //更新滚动条事件
                    let _name='迎检群'
                    $('#chatView').html('')
                    $('.chatBox .chat-name').html(_name)
                    //消息相关操作
                    setMessages()
                }else if(_index==1){
                    //通讯录
                    $('.telbookBox').removeClass('hide')
                    getTelbook('')
                }else if(_index==2){
                    //信好标记
                    $('.mark-Box').removeClass('hide')
                }else if(_index==3){
                    //信号管理
                    $('.signal-Box').removeClass('hide')
                    getEventList()
                }
            })

            //地图控制，搜索，显示点位
            $(document).on('click','.btm-center>div',function(){
                let _index=$(this).index()
                $(this).addClass('active').siblings().removeClass('active')
                //隐藏其他
                $('.allDiv').addClass('hide')
                $('.allDiv2').removeClass('hide')
                if(_index==0){
                    //地图搜索
                    $('.mapSearch').removeClass('hide')
                    $('.mapSearch .w-search-text').val('')
                    $('.mapSearch .searchCont').addClass('hide')
                    //设置缓存数据显示
                    setStoresHtml()
                }else if(_index==1){
                    //图层控制
                    $('.mapSetting').removeClass('hide')
                }else if(_index==2){
                    //图层历史通知
                    $('.noticeList').removeClass('hide')
                    //默认迎检信息-数据
                    getMessPointList()
                }
            })

            //信息管理，选项卡切换
            $(document).on('click','.noticeList .topUl>li',function(){
                let _index=$(this).index()
                $(this).addClass('active').siblings().removeClass('active')
                $('.noticeList .content .son').eq(_index).removeClass('hide').siblings().addClass('hide')
                if(_index==0){
                    //迎检信息-数据
                    getMessPointList()
                }else{
                    let _ars={}
                    getNoticeHistory(_ars)
                }
            })
            
            /** 点位详情选项卡点击事件 **/
            $(document).on('click','.dot-detail .dot-table>li.dot-table-cell',function(){
                $('.dot-detail .dot-table>li.dot-table-cell').removeClass('selected')
                $(this).addClass('selected')
                let _index=$(this).index()
                $('.dot-detail .content-table-div>div.cont').eq(_index).removeClass('hide').siblings().addClass('hide')
                if(_index==0){
                    //巡查详情

                }else if(_index==1){
                    //历史记录

                }else if(_index==2){
                    //数据统计
                    //点位详情-问题统计
                    monthStatis()
                    //点位详情-问题分布
                    distribStatis()
                }
            })
            
            /*关闭窗口事件*/
            $(document).on('click','.close',function(){
                $('.optionBg').addClass('hide')
                $(this).parent().addClass('hide')
                $("#container").css("cursor","");
                _isClickMap = false
                _isAddDot = false
            })

            /*巡检流程*/
            $(document).on('click','.titleBlue',function(){
                $('.Patrol').removeClass('hide')
                $('.optionBg').removeClass('hide')
            })

            /*图例说明*/
            $(document).on('click','.maxBg .explain',function(){
                let _this = $(this)
                if(_this.hasClass('explain2')){
                    _this.removeClass('explain2')
                }else{
                    _this.addClass('explain2')
                }
            })

            /*街道详情-点位数据赛选*/
            $(document).on('click','.street-detail .dot-table>li',function(){
                $(this).addClass('selected').siblings().removeClass('selected')
                let _index = $(this).index()
                let _ars={}
                _ars.ascription = $('#streetName').html()
                if(_index==0){
                    //全部
                }else if(_index==1){
                    //待巡查
                    _ars.watchStatus = 1
                }else if(_index==2){
                    //处理中
                    _ars.fixStatus=3
                }else if(_index==3){
                    //待处理
                    _ars.fixStatus=2
                }else if(_index==4){
                    //已处理
                    _ars.fixStatus=4
                }else if(_index==5){
                    //合格
                    _ars.watchResult='1,2'
                }
                getStreetDot(_ars)
            })

            /*线路标记，地点标记*/
            $(document).on('click','.mark-Box .content>div',function(){
                $(this).addClass('active').siblings().removeClass('active')
                let _index=$(this).index()
                if(_index==0){
                    //地图点击事件
                    _isClickMap = true
                    _isAddDot = false
                    $("#container").css("cursor","url(../images/addre-red.png) 48 48,pointer");
                }else if(_index==2){
                    _isAddDot = true
                    _isClickMap = false
                    $("#container").css("cursor","url(../images/addre-red.png) 48 48,pointer");
                }
                $('.mark-Box').addClass('hide')
            })
        
            /*通讯录 回车搜索*/
            $("body .telbookBox").keydown(function () {
                var _vals = $(".telbookBox .searchView .w-search-text").val();
                if(event.keyCode == '13'){
                    getTelbook(_vals)
                }
            });

            /*地图搜索 回车搜索*/
            $("body .mapSearch").keydown(function () {
                var _vals = $(".mapSearch .searchView .w-search-text").val();
                if(event.keyCode == '13'){
                    searchDot(_vals)
                }
            });

            /*聊天-滚动条上啦加载更多*/
            $('#chatView').scroll(function(){
                let _height = $('#chatView').scrollTop()
                if(_isScroll==true&&_height<100&&_isOne==true){
                    //上啦加载
                    _isOne=false
                    let _ars={}
                    _ars.chatId = _chatId 
                    _ars.rows= _rows
                    _ars.direction='before'
                    _ars.currentTime = newTime
                    getMsg(_ars)
                    setTimeout(()=>{
                        _isOne = true
                    },500)
                }
            })

             /*消息通知历史-滚动条上啦加载更多*/
             $('#noticeListScroll').scroll(function(e){
                var _elements= document.getElementById('noticeListScroll');
                let _top = _elements.scrollTop
                let _scrollHeight = _elements.scrollHeight;
                let _clientHeight  = _elements.clientHeight; 
                let _height = _scrollHeight - _clientHeight - _top;
                if(_isScrollNotice==true&&_height<100){
                    _noticeRow = _noticeRow+1
                    //上啦加载
                    _isScrollNotice=false
                    let _ars={}
                    _ars.pageSize= 10
                    _ars.pageIndex= _noticeRow
                    getNoticeHistory(_ars)
                }
            })

            /*地图图层控制*/
            $(document).on('click','.mapSetting  .show-dot',function(e){
                if(e.target.tagName=='INPUT'){
                    let _id = e.target.id
                    let _val = $('#'+_id).is(':checked')

                    if(_id=='checked1'){
                        if(_val==true){
                            //日常点位-kai
                            let _ids=[]
                            for(let i=0; i<_dataType1.length; i++){
                                _ids.push(getDotTpyes(_dataType1[i]))
                            }
                            markerLayer.add(_ids)
                        }else{
                             //日常点位-关
                            let _ids=[]
                            for(let i=0; i<_dataType1.length; i++){
                                _ids.push(_dataType1[i].pointId)
                            }
                            markerLayer.remove(_ids)
                        }
                        
                    }else if(_id=='checked2'){
                        if(_val==true){
                            //随机点位-kai
                            let _ids=[]
                            for(let i=0; i<_dataType2.length; i++){
                                _ids.push(getDotTpyes(_dataType2[i]))
                            }
                            markerLayer.add(_ids)
                        }else{
                             //随机点位-关
                            let _ids=[]
                            for(let i=0; i<_dataType2.length; i++){
                                _ids.push(_dataType2[i].pointId)
                            }
                            markerLayer.remove(_ids)
                        }
                    }else if(_id=='checked3'){
                        if(_val==true){
                            //待巡查-kai
                            let _ids=[]
                            for(let i=0; i<_dataStaus1.length; i++){
                                _ids.push(getDotTpyes(_dataStaus1[i]))
                            }
                            markerLayer.add(_ids)
                        }else{
                             //随机点位-关
                            let _ids=[]
                            for(let i=0; i<_dataStaus1.length; i++){
                                _ids.push(_dataStaus1[i].pointId)
                            }
                            markerLayer.remove(_ids)
                        }
                    }else if(_id=='checked4'){
                        if(_val==true){
                            //合格点位-kai
                            let _ids=[]
                            for(let i=0; i<_dataStaus2.length; i++){
                                _ids.push(getDotTpyes(_dataStaus2[i]))
                            }
                            markerLayer.add(_ids)
                        }else{
                             //合格点位-关
                            let _ids=[]
                            for(let i=0; i<_dataStaus2.length; i++){
                                _ids.push(_dataStaus2[i].pointId)
                            }
                            markerLayer.remove(_ids)
                        }
                    }else if(_id=='checked5'){
                        if(_val==true){
                            //待处理-kai
                            let _ids=[]
                            for(let i=0; i<_dataStaus3.length; i++){
                                _ids.push(getDotTpyes(_dataStaus3[i]))
                            }
                            markerLayer.add(_ids)
                        }else{
                             //待处理-关
                            let _ids=[]
                            for(let i=0; i<_dataStaus3.length; i++){
                                _ids.push(_dataStaus3[i].pointId)
                            }
                            markerLayer.remove(_ids)
                        }
                    }else if(_id=='checked6'){
                        if(_val==true){
                            //处理中-kai
                            let _ids=[]
                            for(let i=0; i<_dataStaus4.length; i++){
                                _ids.push(getDotTpyes(_dataStaus4[i]))
                            }
                            markerLayer.add(_ids)
                        }else{
                             //处理中-关
                            let _ids=[]
                            for(let i=0; i<_dataStaus4.length; i++){
                                _ids.push(_dataStaus4[i].pointId)
                            }
                            markerLayer.remove(_ids)
                        }
                    }else if(_id=='checked7'){
                        if(_val==true){
                            //已处理-kai
                            let _ids=[]
                            for(let i=0; i<_dataStaus5.length; i++){
                                _ids.push(getDotTpyes(_dataStaus5[i]))
                            }
                            markerLayer.add(_ids)
                        }else{
                             //已处理-关
                            let _ids=[]
                            for(let i=0; i<_dataStaus5.length; i++){
                                _ids.push(_dataStaus5[i].pointId)
                            }
                            markerLayer.remove(_ids)
                        }
                    }else if(_id=='checked8'){
                        if(_val==true){
                            _isShowRole1 = true
                            //巡查员-kai
                            let _ids=[]
                            for(let i=0; i<_dataRole1.length; i++){
                                _ids.push(getDotTpyes2(_dataRole1[i]))
                            }
                            markerLayer.add(_ids)
                        }else{
                            _isShowRole1 = false
                            //巡查员-关
                            let _ids=[]
                            for(let i=0; i<_dataRole1.length; i++){
                                _ids.push(_dataRole1[i].employeeId)
                            }
                            markerLayer.remove(_ids)
                        }
                    }else if(_id=='checked9'){
                        if(_val==true){
                            _isShowRole2 = true
                            //点位长-kai
                            let _ids=[]
                            for(let i=0; i<_dataRole2.length; i++){
                                _ids.push(getDotTpyes2(_dataRole2[i]))
                            }
                            markerLayer.add(_ids)
                        }else{
                            _isShowRole2 = false
                            //点位长-关
                            let _ids=[]
                            for(let i=0; i<_dataRole2.length; i++){
                                _ids.push(_dataRole2[i].employeeId)
                            }
                            markerLayer.remove(_ids)
                        }
                    }else if(_id=='checked10'){
                        if(_val==true){
                            _isShowRole3 = true
                            //网格员-kai
                            let _ids=[]
                            for(let i=0; i<_dataRole3.length; i++){
                                _ids.push(getDotTpyes2(_dataRole3[i]))
                            }
                            markerLayer.add(_ids)
                        }else{
                            //网格员-关
                            _isShowRole3 = false
                            let _ids=[]
                            for(let i=0; i<_dataRole3.length; i++){
                                _ids.push(_dataRole3[i].employeeId)
                            }
                            markerLayer.remove(_ids)
                        }
                    }else if(_id=='checked11'){
                        if(_val==true){
                            _isShowRole4 = true
                            //管理员-kai
                            let _ids=[]
                            for(let i=0; i<_dataAdmin.length; i++){
                                _ids.push(getDotTpyes2(_dataAdmin[i]))
                            }
                            markerLayer.add(_ids)
                        }else{
                            _isShowRole4 = false
                            //管理员-关
                            let _ids=[]
                            for(let i=0; i<_dataAdmin.length; i++){
                                _ids.push(_dataAdmin[i].employeeId)
                            }
                            markerLayer.remove(_ids)
                        }
                    }
                }
            })

            /*websocket连接*/
            setSocket()

            //图片上传
            uploadFiles()

            //显示时间
            showTime()
            //天气-数据
            getWeather()

            //获取消息通知
            getNotice()

            //地图边界显示-各个街镇
            showAreaMaps()

        })

        //检查信息-list
        function getMessPointList(){
            let _url = $.config.apiUrl+'/checkInfo/list';
            let _ars={}
            _ars.pageIndex = 1
            _ars.pageSize = 500
            $.ajax({
                url: _url,
                data: JSON.stringify(_ars),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                async: false,
                success: function(data){
                    if(data.code==200){
                        if(data.data==null||data.data.data==null||data.data.data.length==0){
                            $('#messList').html('<div class="noData">暂无信息！</div>')
                        }else{
                            let _datas = data.data.data
                            let _ul=''
                            for(let i=0; i<_datas.length; i++){
                                let k = i+1
                                if(k<10){
                                    k = '0'+k
                                }
                                let _li="<li>"+
                                            "<span class='table-width1'>"+k+"</span>"+
                                            "<span class='table-width2'>"+_datas[i].check_item+"</span>"+
                                            "<span class='table-width3'>"+_datas[i].check_point+"</span>"+
                                            "<span class='table-width4'>"+
                                                "<span class='show'>"+_datas[i].remarks+"</span>"+
                                                "<span class='edit' onClick='eidtMesspoint(\""+_datas[i].info_id+"\")'></span>"+
                                                "<span class='delete' onClick='delMesspoint(\""+_datas[i].info_id+"\")'></span>"+
                                            "</span>"+
                                        "</li>";
                                        _ul+=_li
                            }
                            $('#messList').html(_ul)
                        }
                    }
                }
            })
        }

        //删除迎检信息
        function delMesspoint(ids){
            var option = {
                title:'提示',
                msg:'确定要删除该信息吗？',
                confirm:function(){
                   //删除并且刷新
                   let _url = $.config.apiUrl+'/checkInfo/delte';
                   let _ars={}
                   _ars.infoId = ids
                   $.ajax({
                        url: _url,
                        data: JSON.stringify(_ars),
                        type: "POST",
                        contentType: "application/json",
                        dataType: "json",
                        async: false,
                        success: function(data){
                            if(data.code==200){
                                $.messageTip.success({
                                    message:"删除成功...",
                                    fadeInTimeOut : 1,
                                    contentTimeOut : 3,
                                    fadeOutTimeOut : 1,
                                });
                                getMessPointList()
                            }else{
                                $.messageTip.error({
                                    message:"删除失败！",
                                    fadeInTimeOut : 1,
                                    contentTimeOut : 3,
                                    fadeOutTimeOut : 1,
                                });
                            }
                        },
                    })
                },
                cancel:function(){
                    console.log('取消')
                }
            };
            confirm_tips(option);
        }

        //修改迎检信息
        function eidtMesspoint(ids){
            _upMessId = ids
            $('.editMess').removeClass('hide')
            $('.noticeList').addClass('hide')
            let _url = $.config.apiUrl+'/checkInfo/info';
            let _ars={}
            _ars.infoId = ids
            $.ajax({
                url: _url,
                data: JSON.stringify(_ars),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                async: false,
                success: function(data){
                    if(data.code==200&&data.data!==null){
                        $('#mess-name2').val(data.data.checkPoint)
                        $('#mess-type2').val(data.data.checkItem)
                        //$('#mess-info2').val(data.data.checkText)
                        $('#mess-remark2').val(data.data.remarks)
                    }
                }
            })
        }

        //初始化，显示各个街道的坐标
        function showAreaMaps(){
            //首先显示所有的浦东新区
            /*let _streetAll = $.config.streetAll() 
            let _paths=[]
			for(let i=0; i<_streetAll.length; i++){
				let _a1 = new TMap.LatLng(_streetAll[i][1],_streetAll[i][0])
				_paths.push(_a1)
            }
            //区域面积
            _polylineLayer = new TMap.MultiPolygon({
                map: _map,//绘制到目标地图
                //折线样式定义
                styles: {
                    'polygon': new TMap.PolygonStyle({
                        'color': 'rgba(50, 197, 255,0.1)', //面填充色
                        'showBorder':true, //是否显示拔起面的边线
                        'borderColor': 'rgba(50, 197, 255,0.8)' //边线颜色
                    })
                },
                //折线数据定义
                geometries: [
                    {//第1条线,浦东新区所有
                        'id': 'pl_All',//折线唯一标识，删除时使用
                        'styleId': 'polygon',//绑定样式名
                        'paths': _paths,
                    },
                ]
            });*/

            //显示各个街道的坐标
            let _streetArea = $.config._streetArea.features;
            for(let i=0; i<_streetArea.length; i++){
                let _street3=_streetArea[i].geometry.coordinates[0]
                showAreaOne(_street3,i)
			}
            
        }

        function showAreaOne(datas,k){
            let _paths=[]
			for(let i=0; i<datas.length; i++){
				let _a1 = new TMap.LatLng(datas[i][1]-0.002,datas[i][0]+0.0046)
				_paths.push(_a1)
            }
            //区域面积
            _polylineLayer = new TMap.MultiPolygon({
                map: _map,//绘制到目标地图
                //折线样式定义
                styles: {
                    'polygon': new TMap.PolygonStyle({
                        'color': 'rgba(50, 197, 255,0.1)', //面填充色
                        'showBorder':true, //是否显示拔起面的边线
                        'borderColor': 'rgba(50, 197, 255,0.8)' //边线颜色
                    }),
                },
                //折线数据定义
                geometries: [
                    {//第1条线
                        'id': 'pl_'+k,//折线唯一标识，删除时使用
                        'styleId': 'polygon',//绑定样式名
                        'paths': _paths,
                    },
                ]
            });
        }

        //查询专业定位设备信息
        function getDeviceDetail(code){
            let deviceUrl = $.config.apiUrl+'/equipment/additional';
            let deviceQuery = {}
            deviceQuery.equCode =  code
            $.ajax({
                url: deviceUrl,
                data: JSON.stringify(deviceQuery),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                success: function(data){
                    if(data.code==200&&data.data!==null){
                        $('#deviceshow').removeClass('hide')
                        $('.deviceLoadding').addClass('hide')
                        let _deviceData = data.data
                        //心率
                        if(_deviceData.deviceHeart==null){
                            $('#deviceshow .xl').html('暂无心率')
                        }else{
                            $('#deviceshow .xl .name').html('温度：'+_deviceData.deviceHeart.H+'次/分钟')
                            $('#deviceshow .xl .time').html('测量时间：'+_deviceData.deviceHeart.absTime)
                        }
                        //步数
                        if(_deviceData.deviceStep==null){
                            $('#deviceshow .bs').html('暂无步数')
                        }else{
                            $('#deviceshow .bs .name').html('步数：'+_deviceData.deviceStep.S+' 步')
                            $('#deviceshow .bs .time').html('测量时间：'+_deviceData.deviceStep.date)
                        }
                        //温度
                        if(_deviceData.wd==null){
                            $('#deviceshow .wd').html('暂无温度')
                        }else{
                            $('#deviceshow .wd .name').html('温度：'+_deviceData.wd.W+'℃')
                            $('#deviceshow .wd .time').html('测量时间：'+_deviceData.wd.absTime)
                        }
                    }else{
                        $('.deviceLoadding').addClass('hide')
                        $('#deviceNo').removeClass('hide')
                    }
                }
            });
        }
            
        //消息通知-显示一条
        function getNotice(){
            let _ars={}
            _ars.cfgCode = 'SYS.NOTICE.SHOW'
            let _url = $.config.apiUrl+'/sysCfg/loadCfg';
            $.ajax({
                url: _url,
                data: JSON.stringify(_ars),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                async: false,
                success: function(data){
                    if(data.code==200&&data.data!==null){
                        let _code = data.data.cfgValue
                        if(parseInt(_code)==1){
                            _noticeSys=true
                            //获取第一条消息通知，并且显示
                            let _url2 = $.config.apiUrl+'/notice/list';
                            $.ajax({
                                url: _url2,
                                data: '{}',
                                type: "POST",
                                contentType: "application/json",
                                dataType: "json",
                                async: false,
                                success: function(res){
                                    if(res.code==200&&res.data!==null){
                                        if(res.data.data!==null){
                                            //判断是否为最新的-有图片的情况
                                            let _datas = res.data.data[0]
                                            let _isnew = (_datas.notice_title).indexOf('isNew')
                                            if(_isnew>0){
                                                let _imgsHtml=''
                                                let _imgData = JSON.parse(_datas.notice_title)
                                                let _imgs = _imgData.imglist.split(',')
                                                _imgs.map(item=>{
                                                    let _src = $.config.imgCom+item
                                                    _imgsHtml+="<div class='noticeImg'><img class='img' src="+_src+" onClick='imgsClick(\""+_src+"\")' /></div>"
                                                })
                                                $('.noticeBox #noticeImgs').removeClass('hide')
                                                $('.noticeBox #noticeImgs').html(_imgsHtml)
                                            }else{
                                                $('.noticeBox #noticeImgs').addClass('hide')
                                            }
                                            let _text = _datas.notice_text
                                            $('.noticeBox').removeClass('hide')
                                            $('.noticeBox #noticeId').html(_text)
                                        }
                                    }
                                }
                            })
                        }else{
                            _noticeSys=false
                        }
                    }
                }
            })
        }
        //消息通知-历史记录
        function getNoticeHistory(ars){
            let _url2 = $.config.apiUrl+'/notice/list';
            $.ajax({
                url: _url2,
                data: JSON.stringify(ars),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                async: false,
                success: function(res){
                    if(res.code==200&&res.data!==null){
                        if(res.data.data!==null){
                            let _datas = res.data.data
                            for(let i=0; i<_datas.length; i++){
                                noticePush(_datas[i])
                            }
                            if(_datas.length==10){
                                _isScrollNotice=true
                            }else{
                                $('#noticeList').append('<div class="noData">无更多通知！</div>')
                            }
                            //允许下拉
                            
                        }else{
                            _isScrollNotice = false  
                            $('#noticeList').append('<div class="noData">暂无通知记录！</div>')
                        }
                    }else{
                        _isScrollNotice = false
                        $('#noticeList').append('<div class="noData">暂无通知记录！</div>')
                    }
                }
            })
        }

        //消息通知push
        function noticePush(datas){
            //判断是否为zuixin
            let _isnew = (datas.notice_title).indexOf('isNew')
            let _imgsHtml=''
            if(_isnew>0){
                let _imgData = JSON.parse(datas.notice_title)
                let _imgs = _imgData.imglist.split(',')
                _imgs.map(item=>{
                    let _src = $.config.imgCom+item
                    _imgsHtml+="<div class='noticeImg'><img class='img' src="+_src+" onClick='imgsClick(\""+_src+"\")' /></div>"
                })
            }
            let _li = '<li class="li">'+
                            '<div class="topfix">'+
                                '<span class="icon"></span>'+    
                                '<span class="titles">创城通知</span>'+    
                                '<span class="time">'+datas.create_time+'</span>'+    
                            '</div>'+
                            '<div class="contents">'+
                                '<div class="noticeImgBox">'+_imgsHtml+'</div>'+
                                '<div class="cont">'+datas.notice_text+'</div>'+
                            '</div>'+
                       '</li>'
            $('#noticeList').append(_li)
        }

        function hideNotice(){
            $('.noticeBox').addClass('hide')
            $('.noticeIcon').removeClass('hide')
        }

        function showNotice(){
            $('.noticeBox').removeClass('hide')
            $('.noticeIcon').addClass('hide')
        }

        //街镇排名、下拉框下拉字段，条件赛选
        function selectchange(val){
            val = parseInt(val)
            if(val!==_streetRole_term){
                _streetRole_term = val
                streetStatis(_streetRole_area,_streetRole_random,val)
            }
        }

        //获取当前周期
        function getWeekData(){
            let _url = $.config.apiUrl+'/weekCount/listResetRecord';
            $.ajax({
                    url: _url,
                    data: '{}',
                    type: "POST",
                    contentType: "application/json",
                    dataType: "json",
                    async: false,
                    success: function(data){
                        if(data.code==200){
                            let _datas = data.data[0]
                            _endTimes = setTimesYear();
                            if(_datas.endTime==null){
                               let _endTime = $.config.setTimes();
                                _datas.endTime=_endTime
                                _weeksData.push(_datas)
                            }else{
                                _weeksData.push(_datas)
                            }
                        }
                    }
                })
        }

        //巡查统计-详情分布图
        function getStatis(names){
            $('.statis-detail').removeClass('hide')
            if($('.street-detail').hasClass('hide')){
                $('.statis-detail').css('left','680px')
            }else{
                $('.statis-detail').css('left','1060px') 
            }
            //获取周期
            if(_weeksData.length==0){
                getWeekData()
            }
            $('.statis-detail .statis-content .years').html('截止到'+_endTimes)
            //问题数据统计
            let _url2
            let _ars={}
            _ars.order='desc'
            _ars.roundPoint='-1'
            _ars.sort='pass_count/total_count'
            _ars.startTime=_weeksData[0].startTime
            _ars.endTime=_weeksData[0].endTime

            //获取-问题分布数据
            let _url3;
            let _ars2={}
            _ars2.order='desc'
            _ars2.roundPoint='-1'
            _ars2.sort='cycle_error_count'
            _ars2.startTime=_weeksData[0].startTime
            _ars2.endTime=_weeksData[0].endTime
            _ars2.pageIndex=1
            _ars2.pageSize=10

            let _areaname = ''
            if(names!==''){
                //全部  
                _areaname = $('#streetName').html()
                $('.statis-detail .namess').html(_areaname)
            }else{
                $('.statis-detail .namess').html('浦东新区')
            }
            let _shows;
            //获取-统计数据
            if(_streetRole_area==0){
                _url2 = $.config.apiUrl+'/weekCount/areaTrendSummary';
                _url3 = $.config.apiUrl+'/weekCount/itemList';
                _ars2.areaName=_areaname
                if(_statisDataStreet.length==0){
                    $.ajax({
                        url: _url2,
                        data: JSON.stringify(_ars),
                        type: "POST",
                        contentType: "application/json",
                        dataType: "json",
                        async: false,
                        success: function(data){
                            if(data.code==200){
                                let _datas = data.data
                                _statisDataStreet = _datas
                                if(_datas!==null){
                                    if(names==''){
                                        //全部
                                        for(let i=0; i<_datas.length; i++){
                                            if(_datas[i].area_name==null){
                                                _shows = _datas[i]
                                                break;
                                            }
                                        }
                                    }else{
                                        //只定地区
                                        for(let i=0; i<_datas.length; i++){
                                            if(_datas[i].area_name==_areaname){
                                                _shows = _datas[i]
                                                break;
                                            }
                                        }
                                    }
                                    
                                } 
                            }
                        }
                    })
                }else{
                    //有数据，直接去缓存数据
                    let _datas = _statisDataStreet
                    if(names==''){
                        //全部
                        for(let i=0; i<_datas.length; i++){
                            if(_datas[i].area_name==null){
                                _shows = _datas[i]
                                break;
                            }
                        }
                    }else{
                        //只定地区
                        for(let i=0; i<_datas.length; i++){
                            if(_datas[i].area_name==_areaname){
                                _shows = _datas[i]
                                break;
                            }
                        }
                    }
                }
                
            }else if(_streetRole_area==1){
                //单位数据
                _url2 = $.config.apiUrl+'/weekCount/orgTrendSummary';
                _url3 = $.config.apiUrl+'/weekCount/itemList';
                _ars2.orgId = _orgId
                //单位数据
                if(_statisDataOrg.length==0){
                    $.ajax({
                        url: _url2,
                        data: JSON.stringify(_ars),
                        type: "POST",
                        contentType: "application/json",
                        dataType: "json",
                        async: false,
                        success: function(data){
                            if(data.code==200){
                                let _datas = data.data
                                _statisDataOrg = _datas
                                if(_datas!==null){
                                    if(names==''){
                                        //全部
                                        for(let i=0; i<_datas.length; i++){
                                            if(_datas[i].org_name==null){
                                                _shows = _datas[i]
                                                break;
                                            }
                                        }
                                    }else{
                                        //只定地区
                                        for(let i=0; i<_datas.length; i++){
                                            if(_datas[i].org_name==_areaname){
                                                _shows = _datas[i]
                                                break;
                                            }
                                        }
                                    }
                                    
                                } 
                            }
                        }
                    })
                }else{
                    //有数据，直接去缓存数据
                    let _datas = _statisDataOrg
                    if(names==''){
                        //全部
                        for(let i=0; i<_datas.length; i++){
                            if(_datas[i].org_name==null){
                                _shows = _datas[i]
                                break;
                            }
                        }
                    }else{
                        //只定地区
                        for(let i=0; i<_datas.length; i++){
                            if(_datas[i].org_name==_areaname){
                                _shows = _datas[i]
                                break;
                            }
                        }
                    }
                }
            }

            //整合数据
            //合格率
            let _hege = getHglv(_shows)
            $('.statis-content .items1 .nos').html(_hege+'%')
            //巡防点位
            $('.statis-content .items2 .nos').html(_shows.total_count)
            //巡防率
            let _xflv = getXflv(_shows)
            $('.statis-content .items3 .nos').html(_xflv+'%')
            //整改率
            let _zglv = getZglv(_shows)
            $('.statis-content .items4 .nos').html(_zglv+'%')
            //待巡查点位
            $('.statis-content .items5 .nos').html(_shows.stay_check)
            //合格点位
            $('.statis-content .items6 .nos').html(_shows.pass_count)
            //问题点位
            $('.statis-content .items7 .nos').html(getPronum(_shows))
            //整改点位
            $('.statis-content .items8 .nos').html(_shows.stay_review)
            //巡防检查项
            $('.statis-content .items9 .nos').html(getXfnum(_shows))
            //发现问题数
            $('.statis-content .items10 .nos').html(_shows.fault_count)
            let _prolv = getprolv(_shows)
            //问题整改率
            $('.statis-content .items11 .nos').html(_prolv+'%')
            //问题整改数
            $('.statis-content .items12 .nos').html(_shows.fix_count)

            $('#topStatis').html('')
            $('#topStatis').attr('_echarts_instance_','')
            $('.statis-detail .statis-list').html('<image class="imgs" src="../images/loadding.gif"/>')
            //问题分布
            $.ajax({
                url: _url3,
                data: JSON.stringify(_ars2),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                success: function(data){
                    if(data.code==200){
                        if(data.data!==null&&data.data.data!==null){
                            //statis-list
                            let _datas = data.data.data
                            let _ul=''
                            let _showData=[]
                            let _names
                            for(let i=0; i<10; i++){
                                let _li = '<li class="li">'+(i+1)+'. '+_datas[i].item_text+'</li>'
                                if(_datas[i].cycle_error_count>0){
                                    let _ar={}
                                    _ar.value = _datas[i].cycle_error_count
                                    _ar.name = _datas[i].item_text
                                    _showData.push(_ar)
                                    _names = _datas[i].item_text
                                    _ul+= _li
                                }
                            }
                            if(_showData.length==0){
                                $('.statis-detail .statis-list').html('<span class="noData">暂无问题</span>')
                                return false
                            }
                            $('.statis-detail .statis-list').html(_ul)
                            //统计数据
                            //点位统计-显示饼状图
                            let dom = document.getElementById("topStatis");
                            let myChart = echarts.init(dom);
                            let option = null;
                            option = {
                                color:['#4c7edc','#4cbc95','#4d6483','#cfa61a','#c35d46','#5caed0','#7b64b4','#d68949','#1e8788','#d687ad'],
                                tooltip: {
                                    show:true,
                                    trigger: 'item',
                                    formatter: s=>{
                                        let _index = s.dataIndex 
                                        _showsWeek=''
                                        let _newHtml = getLines(_showData[_index].name)
                                        _showsWeek = '<div style="float: left; width: 200px;">问题数量：'+_showData[_index].value+'<br/><p style="word-break:break-all;">'+_newHtml+'</p></div>';
                                        return _showsWeek
                                    }
                                },
                                series: [
                                    {
                                        name: '',
                                        type: 'pie',
                                        radius: ['50%', '70%'],
                                        avoidLabelOverlap: false,
                                        label: {
                                            show: false,
                                            position: 'center'
                                        },
                                        emphasis: {
                                            label: {
                                                show: true,
                                                fontSize: '16',
                                            }
                                        },
                                        labelLine: {
                                            show: false
                                        },
                                        data: _showData,
                                        label: {
                                            normal: {
                                                show: true,
                                                position: 'center',
                                                formatter:function (argument) {
                                                    if(argument.data.name==_names){
                                                        var html;
                                                        html='10大问题\r\n\r\n排名前十的问题分布';
                                                        return html;
                                                    }else{
                                                        return ''
                                                    }
                                                },
                                                textStyle:{
                                                   fontSize: 16,
                                                   color:'#fff'
                                                }
                                            }
                                        },
                                    }
                                ]
                            };
                            if (option && typeof option === "object") {
                                myChart.setOption(option, true);
                            }
                        }else{
                            $('.statis-detail .statis-list').html('<span class="noData">暂无问题</span>')
                            return false
                        }

                    }
                }
            })
        }
        //问题整改率
        function getprolv(_datas){
            if(_datas.fault_count==0){
                return 0
            }else{
                let _fix = parseFloat(_datas.fix_count/_datas.fault_count)
                _fix=(_fix*100).toFixed(2)
                return _fix
            }
        }
        //计算巡防数
        function getXfnum(_datas){
            return (_datas.total_count - _datas.stay_check);
        }
        //计算合格率
        function getHglv(_datas){
            if(_datas.total_count==0){
                return 0
            }else{
                let _fix = parseFloat(_datas.pass_count/_datas.total_count)
                _fix=(_fix*100).toFixed(2)
                return _fix
            }
        }
        //计算巡防率
        function getXflv(_datas){
            if(_datas.total_count==0){
                return 0
            }else{
                let _fix = parseFloat((_datas.total_count -_datas.stay_check)/_datas.total_count)
                _fix=(_fix*100).toFixed(2)
                return _fix
            }
        }
        //计算整改率
        function getZglv(_datas){
            if((_datas.stay_review+_datas.fixing+_datas.stay_fix)==0){
                return 0
            }else{
                let _fix = parseFloat((_datas.stay_review/(_datas.stay_review+_datas.fixing+_datas.stay_fix)))
                _fix=(_fix*100).toFixed(2)
                return _fix
            }
        }
        //计算问题数
        function getPronum(_datas){
            return (_datas.stay_review+_datas.fixing+_datas.stay_fix)
        }
        //年月日
        function setTimesYear() {
			var date = new Date();//时间戳为10位需*1000，时间戳为13位的话不需乘1000
            var Y = date.getFullYear() + '年';
            var M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '月';
            var D = (date.getDate() < 10 ? '0'+date.getDate() : date.getDate()) + '日';
            let strDate = Y+M+D;
			return strDate;
		}

        //动态生成点位，返回对象,---点位
        function getDotTpyes(datas){
            let _type = datas.pointType
            if(_type==-1){
                let _status = getStatus(datas)
                let _arName =  'styleMark'
                let _ar={}
                _ar.id = datas.pointId
                _ar.styleId = _arName
                _ar.position = new TMap.LatLng(datas.dimension, datas.longitude)
                _ar.properties=datas
                _ar.properties.type = 'styleMark' //类型，点位
                return _ar
            }else{
                let _status = getStatus(datas)
                let _arName =  'style_'+_type+'_'+_status
                let _ar={}
                _ar.id = datas.pointId
                _ar.styleId = _arName
                _ar.position = new TMap.LatLng(datas.dimension, datas.longitude)
                _ar.properties=datas
                _ar.properties.type = 'dot' //类型，点位
                return _ar
            }
        }

        //动态生成点位，返回对象,---地图人员
        function getDotTpyes2(_datas){
            let _ar={}
            _ar.id = _datas.employeeId
            let _arName=''
            if(_datas.roleCode=='dotPatrolNo'||_datas.roleCode=='dotPatrolHas'){
                //巡查员
                if(_datas.equCode==null){
                    _arName = 'styleRole1'
                }else{
                    _arName = 'styleRole1_y'
                }
            }else if(_datas.roleCode=='dotRole'){
                //点位长
                if(_datas.equCode==null){
                    _arName = 'styleRole2'
                }else{
                    _arName = 'styleRole2_y'
                }
            }else if(_datas.roleCode=='dotGrid'){
                //网格员
                if(_datas.equCode==null){
                    _arName = 'styleRole3'
                }else{
                    _arName = 'styleRole3_y'
                }
            }else if(_datas.roleCode=='sysadmin'){
                //管理员
                if(_datas.equCode==null){
                    _arName = 'styleAdmin'
                }else{
                    _arName = 'styleAdmin_y'
                }
            }
            _ar.styleId = _arName
            _ar.position = new TMap.LatLng(_datas.lat, _datas.lng)
            _ar.properties=_datas
            _ar.properties.type = 'employee' //类型，点位
            return _ar
        }

        function getTimes(timestamp) {
            var date = new Date(timestamp);//时间戳为10位需*1000，时间戳为13位的话不需乘1000
            var Y = date.getFullYear() + '-';
            var M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '-';
            var D = (date.getDate() < 10 ? '0'+date.getDate() : date.getDate()) + ' ';
            var h = (date.getHours() < 10 ? '0'+date.getHours() : date.getHours()) + ':';
            var m = (date.getMinutes() < 10 ? '0'+date.getMinutes() : date.getMinutes()) + ':';
            var s = (date.getSeconds() < 10 ? '0'+date.getSeconds() : date.getSeconds());
            
            var strDate = Y+M+D+h+m+s;
            return strDate;
        }

        //根据经纬度，获取地址名称
        function getAddress(_lat2,_lng2,datas){
            let _latss = _lat2+','+_lng2
            let data={
                location: _latss,
                /*换成自己申请的key*/
                key:"K74BZ-5I5KP-FFUDD-L7HQ7-632X6-25F3R",
                get_poi:0    
            }
            var url="http://apis.map.qq.com/ws/geocoder/v1/?";
            data.output="jsonp";  
            $.ajax({
                type:"get",
                dataType:'jsonp',
                data:data,
                jsonp:"callback",
                jsonpCallback:"QQmap",
                url:url,
                async: false,
                success:function(json){
                    if(json.status==0){
                        _address = json.result.address
                        sendSignal2(datas)
                        //隐藏信号管理
                        $('.signal-Box').addClass('hide')
                    }
                },
                error : function(err){
                    _address='地址名称获取失败'
                    sendSignal2(datas)
                }
            })
        }
        //初始化用户数据
        function getUserInfo(){
            let _datas = $.config.getQueryString('datas')
            let _datas2 = JSON.parse(_datas)
            _employeeId = _datas2.id
            _employees = _datas2
        }
        /*** 地图点位状态  ***/
        function getStatus(item){
            if(item.watchStatus==1){
                return 'b'//'待巡查'
            }
            if(item.watchStatus==2&&(item.watchResult==1||item.watchResult==2)){
                return 'c'//'合格'
            }
            if(item.watchStatus==2&&item.watchResult==3&&item.fixStatus==2){
                return 'a'//'待处理'
            }
            if(item.watchStatus==2&&item.watchResult==3&&item.fixStatus==3){
                return 'd'//'处理中'
            }
            if(item.fixStatus==4){
                return 'f'//'已处理'
            }
        }

        //获取状态名称
        function getStatusName(item){
            if(item.watchStatus==1){
                return '待巡查'//'待巡查'
            }
            if(item.watchStatus==2&&(item.watchResult==1||item.watchResult==2)){
                return '合格'//'合格'
            }
            if(item.watchStatus==2&&item.watchResult==3&&item.fixStatus==2){
                return '不合格 · 待处理'//'待处理'
            }
            if(item.watchStatus==2&&item.watchResult==3&&item.fixStatus==3){
                return '不合格 · 处理中'//'处理中'
            }
            if(item.fixStatus==4){
                return '不合格 · 已处理'//'待复核'
            }
        }

        //显示img
        function setImgs(item){
            let status = getStatus(item)
            let pointType = parseInt(item.pointType);
            let icon = $.areaIcon[pointType]?$.areaIcon[pointType].prefix:'3'
            let iconPath = $.config.iconUrl + '/' +icon+status+'@2x.png' //`${iconUrl}/${icon}${status}@2x.png`
            return iconPath
        }
        //显示img-白色图片
        function setImgs2(item){
            let status = getStatus(item)
            let pointType = parseInt(item.pointType);
            let icon = $.areaIcon[pointType]?$.areaIcon[pointType].prefix:'3'
            let iconPath = $.config.iconUrl + '/' +icon+'e@2x.png' //`${iconUrl}/${icon}${status}@2x.png`
            return iconPath
        }
        /* 地图点位-详情点击事件 */
        function dotDetailClick(item,k){
            $('.dot-detail').removeClass('hide')

            /*默认第一项*/
            $('.dot-detail .dot-table>li.dot-table-cell').eq(0).addClass('selected').siblings().removeClass('selected')
            $('.dot-detail .content-table-div>div.cont').eq(0).removeClass('hide').siblings().addClass('hide')

            //点位详情数据
            _details = item
            //详情
            let _imgs = setImgs2(_details)
            let _status = getStatus(_details)
            let _class = ''
            if(_status=='a'){
                _class = 'redBg'
            }else if(_status=='b'){
                _class = 'blueBg'
            }else if(_status=='c'){
                _class = 'greenBg'
            }else if(_status=='d'){
                _class = 'orangeBg'
            }else if(_status=='f'){
                _class = 'yellowBg'
            }
            let _fla = false
            if(_details.contactName==null){
                _fla=true
            }
            if(_fla===true){
                $('.dot-detail .right-cont .mans').addClass('hide')
            }else{
                $('.dot-detail .right-cont .mans').removeClass('hide')
            }
            $('.dot-detail .leftBox').attr('class','leftBox')
            $('.dot-detail .leftBox').addClass(_class)
            $('.dot-detail .leftBox .img').attr('src',_imgs)
            $('.dot-detail .right-cont .title').text(_details.pointName)
            $('.dot-detail .right-cont .mans .name').text(_details.contactName)
            $('.dot-detail .right-cont .mans .phone').text(_details.contactTel)
            $('.dot-detail .right-cont .adds .address').text(_details.pointAddress)
            $('.dot-detail .right-cont .grids .address').text(_details.ascription)

            //巡查情况数据
            getdotHisory(item)
            if(k==0){
                //打开地图点位
                gotoMap(item,1)
            }
        }    
        
        //详情-巡查情况
        function getdotHisory(item){

            $('.dot-detail .content .content-table-div .xuncha-detail').css('width','90%')
            $('.dot-detail .content .content-table-div .xuncha-detail').html('<div class="noData">暂无巡查记录!</div>')
            $('#historyList').html('<div class="noData">暂无历史记录!</div>')
            //历史记录
            let _ars2={}
            _ars2.pointId = item.pointId
            _ars2.pageIndex = 1
            _ars2.pageSize = 10
            let _url = $.config.apiUrl+'/checkpoint/listCheckRecord';
            $.ajax({
                url: _url,
                data: JSON.stringify(_ars2),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                async: false,
                success: function(data){
                    if(data.code==200){
                        if(data.data.data==null){
                            $('#hasRules').html('')
                        }else{
                            let _datas = data.data.data[0]
                            let _shows=''
                            if(_datas.passCount!==0){
                                _shows+=_datas.passCount+'个合格、'
                            }else if(_datas.faultCount!==0){
                                _shows+=_datas.faultCount+'个不合格、'
                            }
                            let _status = getStatus(_datas)
                            let _statusShow=''
                            if(_datas.checkResult==1||_datas.checkResult==2){
                                //'合格'
                                _statusShow = "<div class='label big green'>合格</div>"
                            }else if(_datas.checkResult==3&&_datas.fixStatus==2){
                                //'不合格·待处理'
                                _statusShow = "<div class='label big red'>不合格 · 待处理</div>"
                            }else if(_datas.checkResult==3&&_datas.fixStatus==3){
                                _statusShow = "<div class='label big orange'>不合格 · 处理中</div>"
                            }else if(_datas.checkResult==3&&_datas.fixStatus==4){
                                //'处理中'
                                _statusShow = "<div class='label big yellow'>不合格 · 已处理</div>"
                            }
                            let _div = "<div>"+
                                            "<div class='label time'>"+_datas.checkTime+"</div>"+
                                            _statusShow+
                                            "<div class='label red'>"+_shows+"</div>"+
                                            "<div class='label red'>巡查员：<strong class='name'>"+_datas.employeeName+"</strong> <strong class='phone'>"+_datas.employeePhone+"</strong></div>"+
                                        "</div>";
                            $('.dot-detail .content .content-table-div .xuncha-detail').html(_div)

                            //获取历史条例数据
                            getRuleHas(_datas.id)

                            //显示历史记录
                            let _datas3 = data.data.data
                            let _shows3=''
                            for(let i=0; i<_datas3.length; i++){
                                if(_datas3[i].checkResult==1||_datas3[i].checkResult==2){
                                    //'合格'
                                    _statusShow2 = "<div class='status green'>合格</div>"
                                }else if(_datas3[i].checkResult==3&&_datas3[i].fixStatus==2){
                                    _statusShow2 = "<div class='status red'>不合格· 待处理</div>"
                                }else if(_datas3[i].checkResult==3&&_datas3[i].fixStatus==3){
                                    //'合格'
                                    _statusShow2 = "<div class='status orange'>不合格 · 处理中</div>"
                                }else if(_datas3[i].checkResult==3&&_datas3[i].fixStatus==4){
                                    //'处理中'
                                    _statusShow2 = "<div class='status yellow'>不合格 · 已处理</div>"
                                }

                                let _li = "<li class='li'>"+
                                                "<div class='time'>"+
                                                    "<div class='label hide'>"+_datas3[i].id+"</div>"+
                                                    "<div class='label'>"+_datas3[i].checkTime+"</div>"+
                                                "</div>"+
                                                "<div class='man'>"+
                                                    "<div class='label'>"+_datas3[i].employeeName+"</div>"+
                                                    "<div class='phone'>"+_datas3[i].employeePhone+"</div>"+
                                                "</div>"+
                                                _statusShow2+
                                            "</li>"
                                _shows3+=_li
                            }
                            $('#historyList').html(_shows3)

                        }
                    }
                }
            })
        }

        //获取历史巡查的项目数据
        function getRuleHas(ids){
            let _ars={"recordId":ids}
            let _url = $.config.apiUrl+'/checkpoint/loadRecord';
            $.ajax({
                url: _url,
                data: JSON.stringify(_ars),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                async: false,
                success: function(data){
                    if(data.code==200){
                        let _datas2 = data.data.checkRecordItems
                        let _shows=''
                        if(_datas2!==null){
                            for(let i=0; i<_datas2.length; i++){
                                let _show=''
                                let _checkOption = parseInt(_datas2[i].checkOption)

                                if(_checkOption==1||_checkOption==2){
                                    _show = "<div class='right-cont green'>"+
                                                "<div class='imgBox'></div>"+
                                                "<div class='label'>合格</div>"+
                                            "</div>"
                                }else if(_checkOption==3){
                                    _show = "<div class='right-cont red'>"+
                                                "<div class='imgBox'></div>"+
                                                "<div class='label'>不合格</div>"+
                                            "</div>"
                                }

                                //判断图片
                                let _imgs=''
                                let _fix=''
                                let _fixImg=''
                                let _gridBox=''
                                let _grid=''
                                if(_datas2[i].enclosure==null||_datas2[i].enclosure==''){
                                    _imgs=''
                                }else{
                                    //判断是否处理
                                    if(_datas2[i].fixResult==1){
                                        if(_datas2[i].fixEnclosure==null||_datas2[i].fixEnclosure==''){
                                            _fix=''
                                        }else{
                                            let _imgfixData = JSON.parse(_datas2[i].fixEnclosure)
                                            let _fixImgList=''
                                            for(let j=0; j<_imgfixData.length; j++){
                                                if(_imgfixData[j]!==''){
                                                    _fixImgList+="<span class='fixImg'><img class='img' onClick='imgsClick("+JSON.stringify(setHead(_imgfixData[j]))+")' src='"+$.config.imgCom+_imgfixData[j]+"'/></span>"
                                                }
                                            }
                                            _fixImg='<div class="fixDiv"><div class="fixtitle">已处理-处理图片：</div><div class="fixBox">'+_fixImgList+'</div></div>'
                                        }
                                    }else if(_datas2[i].fixResult==2){
                                        _fixImg='<div class="fixDiv"><div class="fixtitle">已处理-上报系统</div><p class="fixBox">单号：'+_datas2[i].gridId+'</p></div>'
                                    }

                                    let _k = _datas2[i].enclosure.split(',')
                                    //去掉第一个空字符串
                                    let _imgData = _k
                                    for(let j=0; j<_imgData.length; j++){
                                        if(_imgData[j]!==''){
                                            _imgs+= "<li>"+
                                                    "<div class='imgBox' onClick='imgsClick("+JSON.stringify(setHead(_imgData[j]))+")'>"+
                                                        "<img src='"+setHead(_imgData[j])+"' class='img' />"+
                                                    "</div>"+
                                                "</li>"
                                        }
                                        
                                    }
                                }

                                //判断网格工单处理
                                if(_datas2[i].gridId!==null&&_datas2[i].gridFeedBack!==null){
                                    let _datas3 = JSON.parse(_datas2[i].gridFeedBack)
                                    //处理结果
                                    let _fixText=''
                                    let _fixNum = _datas3.banliresult
                                    if(_fixNum==0){
                                        _fixText='已处理'
                                    }else if(_fixNum==1){
                                        _fixText='未处理'
                                    }else if(_fixNum==2){
                                        _fixText='部分处理'
                                    }else if(_fixNum==3){
                                        _fixText='不处理，退单'
                                    }
                                    _gridBox = '<div class="fixDiv"><div class="fixtitle">系统处理结果：'+_fixText+'</div><p class="fixBox">单号：'+_datas2[i].gridId+'</p></div>'
                                    if(_datas3.checkimage&&_datas3.checkimage!==null&&_datas3.checkimage!==''){
                                        let _datas4 = _datas3.checkimage.split(',')
										let _imgss = ''
										for(let k=0; k<_datas4.length; k++){
											if(_datas4[k]!==''){
                                                let _imgs2 = $.config.imgComGrid + _datas4[k]
												_imgss+= "<li class='li'>"+
                                                    "<div class='imgBox' onClick='imgsClick("+JSON.stringify(_imgs2)+")'>"+
                                                        "<img src='"+_imgs2+"' class='img' />"+
                                                    "</div>"+
                                                "</li>"
											}
                                        }
                                        _grid='<div class="fixDiv noborder">'+_imgss+'</div>';
                                    }
                                }


                                let _li = "<li class='li'>"+
                                                "<div class='left-cont'>"+
                                                    "<div class='cont'>"+(i+1)+'. '+_datas2[i].itemText+"</div>"+
                                                    "<ul class='imgList'>"+
                                                        _imgs+_fixImg+_gridBox+_grid+
                                                    "</ul>"+
                                                "</div>"+
                                                _show+
                                            "</li>"
                                _shows+=_li
                            }
                            $('#hasRules').html(_shows)
                        }else{
                            $('#hasRules').html('')
                        }
                    }
                }
            });
        }

        /*图片点击放大*/
        function imgsClick(imgs){
            $('.BigimgBox').removeClass('hide')
            $('.BigimgBox .imgBox .img').attr('src',imgs)
        }

        /*地图点位 - 搜素*/
        function searchDot(names){
            let _url = $.config.apiUrl+'/checkpoint/list';
            let _ars = {"pageIndex":1,"pageSize":20,"roundPoint":0}
            _ars.pointName = names
            $.ajax({
                url: _url,
                data: JSON.stringify(_ars),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                async: false,
                success: function(data){
                    if(data.code==200){
                        let _datas = data.data.data
                        $('.mapSearch .message-no-data').addClass('hide')
                        $('.mapSearch #historyCont').addClass('hide')
                        $('#searchCont').removeClass('hide')
                        if(_datas!==null){
                            let _ul=''
                            for(let i=0; i<_datas.length; i++){
                                let _li = "<li class='li'>"+
                                            "<div class='left-icon'>"+
                                                "<img src='../images/address.png' class='img'/>"+
                                                "</div>"+
                                                "<div class='cont' onclick='gotoMap("+JSON.stringify(_datas[i])+",0)'>"+
                                                    "<div class='titles'>"+_datas[i].pointName+"</div>"+
                                                    "<div class='titles small'>"+_datas[i].pointAddress+"</div>"+
                                                "</div>"+
                                            "</li>"
                                _ul+=_li
                            }  
                            $('#searchCont').html(_ul) 
                        }else{
                            $('#searchCont').html('<div class="noData">无搜索点位数据！</div>') 
                        }
                    }
                },
                error: function(error){
                    alert('初始化点位数据失败！')
                }
            })
        }

        //显示缓存数据-html
        function setStoresHtml(){
            let _datas = getStores('_mapsearchData')
            if(_datas.length==0){
                $('.message-no-data').removeClass('hide')
            }else{
                $('#historyCont').removeClass('hide')
                let _ul=''
                for(let i=0; i<_datas.length; i++){
                    let _li = "<li class='li'>"+
                                "<div class='left-icon'>"+
                                    "<img src='../images/address.png' class='img'/>"+
                                    "</div>"+
                                    "<div class='cont' onclick='gotoMap("+JSON.stringify(_datas[i])+",1)'>"+
                                        "<div class='titles'>"+_datas[i].pointName+"</div>"+
                                        "<div class='titles small'>"+_datas[i].pointAddress+"</div>"+
                                    "</div>"+
                                "</li>"
                    _ul+=_li
                }  
                $('#historyCont .message-content').html(_ul) 
            }
        }
        
        //删除历史记录
        function deleHistory(){
            localStorage.removeItem('_mapsearchData');
            setStoresHtml();
            $('.historyBox').addClass('hide')
            $('.historyBox .message-content').html('')
        }

        //获取缓存-data
        function getStores(names){
            return JSON.parse(localStorage.getItem(names))||[]
        }

        //设置缓存-data
        function setStores(item,names){
            //去重
            let _datas = getStores(names)
            let _fla = false
            for(let i=0; i<_datas.length; i++){
                if(_datas[i].pointId == item.pointId){
                    _fla = true
                    break;
                }
            }
            if(!_fla){
                _datas.push(item)
                localStorage.setItem(names,JSON.stringify(_datas))
            }
        }

        /*跳转到地图*/
        function gotoMap(datas,k){
            if(k==0){
                //设置缓存
                setStores(datas,'_mapsearchData')
            }
            //跳转地图点位
            $('.mapSearch').addClass('hide')
            let _ars={}
            _ars.geometry={}
            let _news =  new TMap.LatLng(datas.dimension,datas.longitude)
            _ars.geometry.position= _news //{'lat':datas.dimension,'lng':datas.longitude}
            _ars.geometry.properties = datas
            _ars.geometry.styleId = 'style_17_c'
            _ars.geometry.properties.type='dot'
            markerLayer.emit('click',_ars)
            _map.setCenter(_news)
        }

        /*地图点位 - 所有点位*/
        function getAlldot(){
            let _url = $.config.apiUrl+'/checkpoint/list';
            let _ars = {"pageIndex":1,"pageSize":2000}
            $.ajax({
                url: _url,
                data: JSON.stringify(_ars),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                async: false,
                success: function(data){
                    if(data.code==200){
                        let _datas = data.data.data
                        oldAllData = _datas
                        if(_datas!==null){
                            //初始化地图点位数据
                            //let _all=[]
                            let _newStyle = _styles 
                            //点位样式
                            for(let i=0; i<_datas.length; i++){
                                let _type = parseInt(_datas[i].pointType)
                                let _status = getStatus(_datas[i])
                                //性质
                                /*if(_datas[i].roundPoint==0){
                                    //日常
                                    _dataType1.push(_datas[i])
                                }else{
                                    //随机
                                    _dataType2.push(_datas[i])
                                }*/
                                if(_status=='a'){
                                    //待处理
                                    _dataStaus3.push(_datas[i])
                                }else if(_status=='b'&&_type!==-1){
                                    //待巡查
                                    _dataStaus1.push(_datas[i])
                                }else if(_status=='c'){
                                    //合格
                                    _dataStaus2.push(_datas[i])
                                }else if(_status=='d'){
                                    //处理中
                                    _dataStaus4.push(_datas[i])
                                }else if(_status=='f'){
                                    //已处理
                                    _dataStaus5.push(_datas[i])
                                }
                                if(_type==-1){

                                }else{
                                    let _arName =  'style_'+_type+'_'+_status
                                    let _img = setImgs(_datas[i])
                                    _newStyle[_arName] = new TMap.MarkerStyle({ 
                                        "width": 40,  // 点标记样式宽度（像素）
                                        "height": 40, // 点标记样式高度（像素）
                                        "src": _img,  //图片路径
                                        "anchor": { x: 16, y: 32 }  
                                    })
                                }
                            }

                            _styles = _newStyle
                            for(let i=0; i<_datas.length; i++){
                                if(_datas[i].pointName!==''){
                                    //得到styleId
                                    let _ar = getDotTpyes(_datas[i])
                                    _alldata.push(_ar)
                                }else{
                                    //console.log(_datas[i])
                                }
                            }
                        }
                    }
                },
                error: function(error){
                    alert('初始化点位数据失败！')
                }
            })
        }

        /*获取周边在线人员*/
        function getLineUser(){
            let _url = $.config.apiUrl+'/employee/getOnlineEmployee';
            let _ars={"range":5000000,"lng":_lng,"lat":_lat}
            $.ajax({
                url: _url,
                data: JSON.stringify(_ars),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                async: false,
                success: function(data){
                    if(data.code==200&&data.data!==null){
                        let _datas = data.data
                        if(_lineMan==null){
                             //赋值
                            _lineMan = _datas
                            //清空 原来角色数据 
                            _dataRole1=[]
                            _dataRole2=[]
                            _dataRole3=[]
                            _dataAdmin=[]
                            for(let i=0; i<_datas.length; i++){
                                let _fla = false
                                if(_datas[i].roleCode=='dotPatrolNo'||_datas[i].roleCode=='dotPatrolHas'){
                                    //巡查员
                                    _dataRole1.push(_datas[i])
                                }else if(_datas[i].roleCode=='dotRole'){
                                    //点位长
                                    _dataRole2.push(_datas[i])
                                }else if(_datas[i].roleCode=='dotGrid'){
                                    //网格员
                                    _dataRole3.push(_datas[i])
                                }else if(_datas[i].roleCode=='sysadmin'){
                                    //管理员
                                    _dataAdmin.push(_datas[i])
                                }else{
                                    //否则，不显示
                                    _fla = true
                                }
                                if(!_fla){
                                    let _ar = getDotTpyes2(_datas[i])
                                    _alldata.push(_ar)
                                }
                            }
                        }else{
                            //清空 原来角色数据 
                            _dataRole1=[]
                            _dataRole2=[]
                            _dataRole3=[]
                            _dataAdmin=[]
                            //更新信息
                            let _pushData=[]
                            let _removeIds=[]
                            //更新坐标点
                            for(let i=0; i<_lineMan.length; i++){
                                //先删除，再push
                                _removeIds.push(_lineMan[i].employeeId)
                            }
                            //更新坐标点-all
                            for(let i=0; i<_datas.length; i++){
                                let _fla = false
                                if(_datas[i].roleCode=='dotPatrolNo'||_datas[i].roleCode=='dotPatrolHas'){
                                    //巡查员
                                    if(_isShowRole1 === true){
                                        _fla = true
                                    }else{
                                        _fla = false
                                    }
                                    _dataRole1.push(_datas[i])
                                }else if(_datas[i].roleCode=='dotRole'){
                                    //点位长
                                    if(_isShowRole2 === true){
                                        _fla = true
                                    }else{
                                        _fla = false
                                    }
                                    _dataRole2.push(_datas[i])
                                }else if(_datas[i].roleCode=='dotGrid'){
                                    //网格员
                                    if(_isShowRole3 === true){
                                        _fla = true
                                    }else{
                                        _fla = false
                                    }
                                    _dataRole3.push(_datas[i])
                                }else if(_datas[i].roleCode=='sysadmin'){
                                    //管理员
                                    if(_isShowRole4 === true){
                                        _fla = true
                                    }else{
                                        _fla = false
                                    }
                                    _dataAdmin.push(_datas[i])
                                }
                                if(_fla === true){
                                    //先删除，再push
                                    let _ar = getDotTpyes2(_datas[i])
                                    _pushData.push(_ar)
                                }
                            }
                            markerLayer.remove(_removeIds)
                            markerLayer.add(_pushData)
                            //再一次更新最新的值
                            _lineMan = _datas
                        }
                    }
                },
                error: function(err){

                }
            })
        }
    
        //计算百分比
        function getPercentage(a,b){
            if(b==0||b==null||a==0){
                return 0;
            }else{
                let _a = (a/b)*100
                if(_a<1){
                    return 1
                }else{
                    return parseInt(_a)
                }
            }
            
        }

        //计算百分比圆饼图角度
        function getRote(a,name,father){
            if(a<=50){
                let _num = (a*3.6 - 180)
                $('.'+father+' .'+name+' .left-box .right-deg').css('transform','rotate('+_num+'deg)')
                $('.'+father+' .'+name+' .left-box .left-deg').css('transform','rotate(180deg)')
            }else{
                let _num = (a-50)*3.6-180
                $('.'+father+' .'+name+' .left-box .right-deg').css('transform','rotate(0deg)')
                $('.'+father+' .'+name+' .left-box .left-deg').css('transform','rotate('+_num+'deg)')
            }
        }

        /*综合信息 -问题统计*/
        function problemStatis(k){

            //点位统计
            let _url2 = $.config.apiUrl+'/count/allPointCount';
            let _ars2={}
            $.ajax({
                url: _url2,
                data: JSON.stringify(_ars2),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                async: false,
                success: function(data){
                    if(data.code==200){
                        //合格lv
                        let _pa = getPercentage(data.data.pass_count,data.data.total_count)

                        if(k==0){

                            $('.mess-statis .statis-left-center .content-right .stay_review').html(data.data.stay_review)
                            $('.mess-statis .statis-left-center .content-right .stay_fix').html(data.data.stay_fix)
                            $('.mess-statis .statis-left-center .content-right .fixing').html(data.data.fixing)
                            $('.mess-statis .statis-left-center .content-right .stay_check').html(data.data.stay_check)
                            $('.mess-statis .statis-left-center .content-right .pass_count').html(data.data.pass_count) 

                            //点位统计-显示饼状图
                            let dom = document.getElementById("showChart");
                            let myChart = echarts.init(dom);
                            let option = null;
                            option = {
                                color:['#44D7B6','#0091FF','#FF974D','#F7B500','#FF6F61'],
                                series: [
                                    {
                                        name: '',
                                        type: 'pie',
                                        radius: ['50%', '70%'],
                                        avoidLabelOverlap: false,
                                        label: {
                                            show: false,
                                            position: 'center'
                                        },
                                        emphasis: {
                                            label: {
                                                show: true,
                                                fontSize: '16',
                                            }
                                        },
                                        labelLine: {
                                            show: false
                                        },
                                        data: [
                                            {value: data.data.pass_count, name: '合格'},
                                            {value: data.data.stay_check, name: '待巡查'},
                                            {value: data.data.fixing, name: '处理中'},
                                            {value: data.data.stay_review, name: '已处理'},
                                            {value: data.data.stay_fix, name: '待处理'},
                                        ],
                                        label: {
                                            normal: {
                                                show: true,
                                                position: 'center',
                                                formatter:function (argument) {
                                                    if(argument.data.name=='合格'){
                                                        var html;
                                                        html='合格点位\r\n\r\n'+_pa+'%';
                                                        return html;
                                                    }else{
                                                        return ''
                                                    }
                                                },
                                                textStyle:{
                                                   fontSize: 16,
                                                   color:'#fff'
                                                }
                                            }
                                        },
                                    }
                                ]
                            };
                            if (option && typeof option === "object") {
                                myChart.setOption(option, true);
                            }
                        }

                        

                        //计算-日常保障-点位巡查统计
                        //合格
                        $('#dot-statis-number .number1 .left-box .nums').html(_pa)
                        $('#dot-statis-number .number1 .right-box .num').html(data.data.pass_count)
                        getRote(_pa,'number1','dot-statis')
                        //待巡查
                        let _pa2 = getPercentage(data.data.stay_check,data.data.total_count)
                        $('#dot-statis-number .number2 .left-box .nums').html(_pa2)
                        $('#dot-statis-number .number2 .right-box .num').html(data.data.stay_check)
                        getRote(_pa2,'number2','dot-statis')
                        //已处理
                        let _pa3 = getPercentage(data.data.stay_review,data.data.total_count)
                        $('#dot-statis-number .number3 .left-box .nums').html(_pa3)
                        $('#dot-statis-number .number3 .right-box .num').html(data.data.stay_review)
                        getRote(_pa3,'number3','dot-statis')
                        //处理中
                        let _pa4 = getPercentage(data.data.fixing,data.data.total_count)
                        $('#dot-statis-number .number4 .left-box .nums').html(_pa4)
                        $('#dot-statis-number .number4 .right-box .num').html(data.data.fixing)
                        getRote(_pa4,'number4','dot-statis')
                        //待处理
                        let _pa5 = getPercentage(data.data.stay_fix,data.data.total_count)
                        $('#dot-statis-number .number5 .left-box .nums').html(_pa5)
                        $('#dot-statis-number .number5 .right-box .num').html(data.data.stay_fix)
                        getRote(_pa5,'number5','dot-statis')
                    }
                }
            })

            let _nums = $('#dot-statis-number .totalNum').text()
            if(_nums==854){
                //统计概览
                let _url = $.config.apiUrl+'/count/overview';
                let _ars={}
                $.ajax({
                    url: _url,
                    data: JSON.stringify(_ars),
                    type: "POST",
                    contentType: "application/json",
                    dataType: "json",
                    async: false,
                    success: function(data){
                        if(data.code==200){
                            for(let i=0; i<data.data.length; i++){
                                if(data.data[i].itemCode == 'dotRole'){
                                    $('.mess-statis .statis-left-top .mans-dotRole').html(data.data[i].itemValue)
                                }else if(data.data[i].itemCode == 'dotPatro'){
                                    $('.mess-statis .statis-left-top .mans-dotPatro').html(data.data[i].itemValue)
                                    //计算-日常保障-点位巡查统计
                                    $('#dot-statis-number .totalMan').html(data.data[i].itemValue)
                                }else if(data.data[i].itemCode == 'point'){
                                    $('.mess-statis .statis-left-top .mans-point').html(data.data[i].itemValue)
                                    //计算-日常保障-点位巡查统计
                                    $('#dot-statis-number .totalNum').html(data.data[i].itemValue)
                                }else if(data.data[i].itemCode == 'street'){
                                    $('.mess-statis .statis-left-top .mans-street').html(data.data[i].itemValue)
                                }else if(data.data[i].itemCode == 'roundPoint'){
                                    $('.mess-statis .statis-left-top .suiji').html(data.data[i].itemValue)
                                }else if(data.data[i].itemCode == 'normalPoint'){
                                    $('.mess-statis .statis-left-top .totalNum').html(data.data[i].itemValue)
                                }
                            }
                        }
                    }
                })
                //问题统计
                let _url3 = $.config.apiUrl+'/count/allErrorCount';
                let _ars3={}
                $.ajax({
                    url: _url3,
                    data: JSON.stringify(_ars3),
                    type: "POST",
                    contentType: "application/json",
                    dataType: "json",
                    async: false,
                    success: function(data){
                        if(data.code==200){
                            
                            let _times=[]
                            let _data=[]

                            for(let i=0; i<data.data.length; i++){
                                _times.push((data.data[i].day_str).substring(5))
                                _data.push(data.data[i].fault_count)
                            }

                            let dom = document.getElementById("problem-statis");
                            //清楚数据
                            dom.removeAttribute("_echarts_instance_");
                            let myChart = echarts.init(dom);
                            let option = null;
                            option = {
                                color:['#44D7B6','#0091FF','#FF974D','#F7B500','#FF6F61'],
                                xAxis: {
                                    type: 'category',
                                    boundaryGap: false,
                                    data: _times,
                                    axisLabel: {
                                        show: true,
                                        textStyle: {
                                            color: '#ffffff'
                                        }
                                    },
                                },
                                yAxis: {
                                    type: 'value',
                                    axisLabel: {
                                        show: true,
                                        textStyle: {
                                            color: '#ffffff'
                                        }
                                    },
                                    splitLine:{
                                        show: true,
                                        lineStyle:{
                                            color: 'rgba(0, 145, 255, 0.2)'
                                        }
                                    },
                                },
                                series: [{
                                    data: _data,
                                    type: 'line',
                                    areaStyle: {
                                        normal: {
                                            color: 'rgba(250, 100, 0, 0.7)'
                                        }
                                    },
                                    itemStyle : { normal: {label : {show: true}}}
                                }]
                            };
                            if (option && typeof option === "object") {
                                myChart.setOption(option, true);
                            }
                        }
                    }
                })
            }
        }

        //街道排名，鼠标移动事件
        function getTitle(s){
            let _div='<div style="position:relative; z-index: 999999;">'+s[0].axisValue+'<br/>'+s[0].seriesName+':'+s[0].data+','+s[1].seriesName+':'+s[1].data+','+s[2].seriesName+':'+s[2].data+','+s[3].seriesName+':'+s[3].data+'</div>'
            return _div
        }

        /*街镇排名*/
        function streetStatis(area,random,term){
            //获取周期
            if(_weeksData.length==0){
                getWeekData()
            }
            let _url; //$.config.apiUrl+'/count/pointCountGroupByStreet';
            if(area==0){
                _url = $.config.apiUrl+'/weekCount/areaTrendSummary';
            }else if(area==1){
                _url = $.config.apiUrl+'/weekCount/orgTrendSummary';
            }
            let _ars = {}
            _ars.roundPoint = random
            _ars.order= 'desc'
            _ars.startTime= _weeksData[0].startTime
            _ars.endTime= _weeksData[0].endTime
            //条件
            if(term==0){
                //点位数
                _ars.sort='total_count'
            }else if(term==1){
                //巡访数
                _ars.sort='total_count-stay_check'
            }else if(term==2){
                //合格数
                _ars.sort='pass_count'
            }else if(term==3){
                //不合格数
                _ars.sort='fault_count'
            }else if(term==4){
                //整改数
                _ars.sort='fix_count'
            }else if(term==5){
                //合格率
                _ars.sort='pass_count/total_count'
            }else if(term==6){
                //巡查率
                _ars.sort='(total_count-stay_check)/total_count'
            }else if(term==7){
                //整改率
                _ars.sort='(stay_review/(stay_review+fixing+stay_fix))'
            }
            $.ajax({
                url: _url,
                data: JSON.stringify(_ars),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                async: false,
                success: function(data){
                    if(data.code==200){

                        data.data = data.data.reverse()

                        

                        let _names=[]
                        let _orgs=[] //机构id
                        let _data1=[]  //合格
                        let _data2=[]  //待巡查
                        let _data3=[]  //已处理
                        let _data4=[]  //待处理
                        let _data5=[]  //处理中

                        let _datas=[]

                        if(area==0){
                            for(let i=0; i<data.data.length; i++){
                                if(data.data[i].area_name!==null){
                                    _names.push(data.data[i].area_name)
                                    _data1.push(data.data[i].pass_count)
                                    _data2.push(data.data[i].stay_check)
                                    _data3.push(data.data[i].stay_review)
                                    _data4.push(data.data[i].stay_fix)
                                    _data5.push(data.data[i].fixing)
                                }
                            }
                        }else{
                            for(let i=0; i<data.data.length; i++){
                                if(data.data[i].org_name!==null){
                                    _names.push(data.data[i].org_name)
                                    _orgs.push(data.data[i].org_id)
                                    _data1.push(data.data[i].pass_count)
                                    _data2.push(data.data[i].stay_check)
                                    _data3.push(data.data[i].stay_review)
                                    _data4.push(data.data[i].stay_fix)
                                    _data5.push(data.data[i].fixing)
                                }
                            }
                        }

                        for(let i=0; i<4; i++){
                            let _ar={}
                            if(i==0){
                                _ar.name = '合格'
                                _ar.data = _data1
                                _ar.itemStyle ={
                                    normal: {
                                        color: '#44D7B6', 
                                    }
                                }
                            }else if(i==1){
                                _ar.name = '待巡查'
                                _ar.data = _data2
                                _ar.itemStyle ={
                                    normal: {
                                        color: '#0091FF', 
                                    }
                                }
                            }else if(i==2){
                                _ar.name = '已处理'
                                _ar.data = _data3
                                _ar.itemStyle ={
                                    normal: {
                                        color: '#FF974D', 
                                    }
                                }
                            }else if(i==3){
                                _ar.name = '待处理'
                                _ar.data = _data4
                                _ar.itemStyle ={
                                    normal: {
                                        color: '#F7B500', 
                                    }
                                }
                            }else if(i==4){
                                _ar.name = '处理中'
                                _ar.data = _data5
                                _ar.itemStyle ={
                                    normal: {
                                        color: '#FF6F61', 
                                    }
                                }
                            }
                            _ar.type = 'bar'
                            _ar.stack = '总量'
                            _ar.label = {
                                show: true,
                                position: 'insideRight',
                                formatter: function(params){
                                    if (params.value > 10) {
                                        return params.value;
                                    } else {
                                        return '';
                                    }
                                }
                            }
                            _ar.barWidth = 20
                            _datas.push(_ar)
                        }

                        let dom = document.getElementById("street-statis");
                        //清楚数据
                        dom.removeAttribute("_echarts_instance_");
                        let _myChart = echarts.init(dom);
                        let _option = null;
                        let clickIndex
                        let _aspName;

                        _option = {
                            tooltip: {
                                confine: true,
                                trigger: 'axis',
                                axisPointer: {            // 坐标轴指示器，坐标轴触发有效
                                    type: 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
                                },
                                formatter: s=>{
                                    _aspName = s[0].axisValue
                                    clickIndex = s[0].dataIndex
                                    let _showsN=getTitle(s)
                                    return _showsN
                                },
                            },
                            grid: {
                                left: '3%',
                                right: '4%',
                                bottom: '3%',
                                containLabel: true
                            },
                            xAxis: {
                                type: 'value',
                                splitLine:{
                                    show: false
                                },
                                axisLabel: {
                                    show: true,
                                    textStyle: {
                                        color: '#ffffff'
                                    }
                                },
                            },
                            yAxis: {
                                type: 'category',
                                splitLine:{
                                    show: false
                                },
                                axisLabel: {
                                    show: true,
                                    textStyle: {
                                        color: '#ffffff',
                                        fontSize: 15,
                                    }
                                },
                                data: _names
                            },
                            series: _datas,
                        };
                        _myChart.setOption(_option, true);
                        _myChart.getZr().on('click',(params)=>{
                            //显示街道详情
                            getStreetDetail(area,_aspName)
                            //隐藏巡查统计数据-tu
                            $('.statis-detail').addClass('hide')
                            _orgId = _orgs[clickIndex]
                            //地图区域
                            _streetData = $.config.returnStreetData(_aspName)
                            showArea(_streetData.data,_streetData.key)
                            
                        })
                    }
                }
            })
        }

        //移除选中，恢复原来一样
        function removeArea(datas,k){
            let _idss = 'pl_'+k;
            let _path2=[]
            for(let i=0; i<datas.length; i++){
                let _a1 = new TMap.LatLng(datas[i][1]-0.002,datas[i][0]+0.0046)
                _path2.push(_a1)
            }	
            _polylineLayer.remove(_idss)
            /*_polylineLayer = new TMap.MultiPolygon({
                map: _map,//绘制到目标地图
                styles: {
                'polygon': new TMap.PolygonStyle({
                        'color': 'rgba(50, 197, 255,0.1)', //面填充色
                        'showBorder':true, //是否显示拔起面的边线
                        'borderColor': 'rgba(50, 197, 255,0.8)' //边线颜色
                    }),
                },
                //折线数据定义
                geometries: [
                    {//第1条线
                        'id': _idss,//折线唯一标识，删除时使用
                        'styleId': 'polygon',//绑定样式名
                        'paths': _path2,
                    },
                ]
            });*/
        }

        //显示街道区域
        function showArea(datas,k){
            let _paths=[]
            let _idss = 'pl_'+k;
			for(let i=0; i<datas.length; i++){
				let _a1 = new TMap.LatLng(datas[i][1]-0.002,datas[i][0]+0.0046)
				_paths.push(_a1)
            }
            _map.setCenter(new TMap.LatLng(datas[0][1], datas[0][0]))
            //_map.setZoom(15)
            //将原来的样式变回去
            if(_areaChoose!==null){
                removeArea(_areaChooseData,_areaChoose)
            }
            //选中当前
            _polylineLayer = new TMap.MultiPolygon({
                map: _map,//绘制到目标地图
                //折线样式定义
                styles: {
                    'polygon2': new TMap.PolygonStyle({
                        'color': 'rgba(25, 184, 0,0.1)', //面填充色
                        'showBorder':true, //是否显示拔起面的边线
                        'borderColor': 'rgba(25, 184, 0,0.8)' //边线颜色
                    }),
                },
                //折线数据定义
                geometries: [
                    {//第1条线
                        'id': _idss,//折线唯一标识，删除时使用
                        'styleId': 'polygon2',//绑定样式名
                        'paths': _paths,
                    },
                ]
            });
            /*_polylineLayer.updateGeometries({
                //折线样式定义
                id: 'pl_1',
                styleId: 'polygon',
                paths: _paths,
            })*/
            _areaChoose = k
            _areaChooseData = datas
        }

        //获取街道详情-统计数据
        function getStreetDetail(k,names){
            $('#streetName').html(names)
            $('.street-detail').removeClass('hide')
            //街道统计
            let _url;
            let _ars;
            let _ars2;
            if(k==0){
                //地区
                _ars = {"ascription":names}
                _ars2 = {"ascription":names}
                _url = $.config.apiUrl+'/count/pointCountByStreet';
            }else{
                //单位
                _ars = {"managerOrg":names}
                _ars2 = {}
                _ars2.roundPoint = _streetRole_random
                _ars2.startTime = _weeksData[0].startTime
                _ars2.endTime = _weeksData[0].endTime
                _url = $.config.apiUrl+'/weekCount/orgTrendSummary';
            }
            $.ajax({
                url: _url,
                data: JSON.stringify(_ars2),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                async: false,
                success: function(data){
                    if(data.code==200){
                        let _datas;
                        if(k==0){
                            _datas=data.data
                        }else{
                            let _datas2 = data.data
                            for(let i=0; i<_datas2.length; i++){
                                if(_datas2[i].org_name==names){
                                    _datas=_datas2[i]
                                    break;
                                }
                            }
                        }
                        $('.street-detail .totalNum').html(_datas.total_count)
                        //街道详情-统计数据
                        //合格
                        let _pa = getPercentage(_datas.pass_count,_datas.total_count)
                        $('.street-detail .number1 .left-box .nums').html(_pa)
                        $('.street-detail .number1 .right-box .num').html(_datas.pass_count)
                        getRote(_pa,'number1','street-detail')
                        //待巡查
                        let _pa2 = getPercentage(_datas.stay_check,_datas.total_count)
                        $('.street-detail .number2 .left-box .nums').html(_pa2)
                        $('.street-detail .number2 .right-box .num').html(_datas.stay_check)
                        getRote(_pa2,'number2','street-detail')
                        //已处理
                        let _pa3 = getPercentage(_datas.stay_review,_datas.total_count)
                        $('.street-detail .number3 .left-box .nums').html(_pa3)
                        $('.street-detail .number3 .right-box .num').html(_datas.stay_review)
                        getRote(_pa3,'number3','street-detail')
                        //处理中
                        let _pa4 = getPercentage(_datas.fixing,_datas.total_count)
                        $('.street-detail .number4 .left-box .nums').html(_pa4)
                        $('.street-detail .number4 .right-box .num').html(_datas.fixing)
                        getRote(_pa4,'number4','street-detail')
                        //待处理
                        let _pa5 = getPercentage(_datas.stay_fix,_datas.total_count)
                        $('.street-detail .number5 .left-box .nums').html(_pa5)
                        $('.street-detail .number5 .right-box .num').html(_datas.stay_fix)
                        getRote(_pa5,'number5','street-detail')
                    }
                }
            })
            
            //获取点位数据
            getStreetDot(_ars)
        }
        
        //街道详情-具体点位数据
        function getStreetDot(ars){
            //显示街道具体点位 数据
            let _url2 = $.config.apiUrl+'/checkpoint/list';
            ars.pageIndex=1
            ars.pageSize=1000
            $.ajax({
                url: _url2,
                data: JSON.stringify(ars),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                async: false,
                success: function(data){
                    if(data.code==200){
                        if(data.data!==null){
                            let _datas = data.data.data
                            if(_datas==null||_datas.length==0){
                                $('#streetDetailUl').html('<div class="noData">暂无数据！</div>')
                            }else{
                                
                                let  _ul=''
                                for(let i=0; i<_datas.length; i++){
                                    let _imgs = setImgs2(_datas[i])
                                    let _status = getStatus(_datas[i])
                                    let _class = ''
                                    if(_status=='a'){
                                        _class = 'redBg'
                                    }else if(_status=='b'){
                                        _class = 'blueBg'
                                    }else if(_status=='c'){
                                        _class = 'greenBg'
                                    }else if(_status=='d'){
                                        _class = 'orangeBg'
                                    }else if(_status=='f'){
                                        _class = 'yellowBg'
                                    }
                                    let _name = ''
                                    if(_datas[i].contactName!==null){
                                        _name = "<div class='cont-box'>"+
                                                "<span class='icon-box userIcon'></span>"+
                                                "<span class='name'>"+_datas[i].contactName+"</span>"+
                                                "<span class='phone'>"+_datas[i].contactTel+"</span>"+
                                            "</div>";
                                    }
                                    let _li ="<li class='detail'>"+
                                        "<div class='left-cont'>"+
                                            "<div class='leftBox "+_class+"'><img class='img' src='"+_imgs+"' /></div>"+
                                        "</div>"+
                                        "<div class='right-cont'>"+
                                            "<div class='title'>"+_datas[i].pointName+"</div>"+
                                            _name+
                                            "<div class='cont-box'>"+
                                                "<span class='icon-box addressIcon'></span>"+
                                                "<span class='address'>"+_datas[i].pointAddress+"</span>"+
                                            "</div>"+
                                                "<div class='cont-box'>"+
                                                    "<span class='icon-box gridIcon'></span>"+
                                                    "<span class='address'>上级管理："+_datas[i].ascription+"</span>"+
                                                "</div>"+
                                                "<div class='li-btn' onclick='dotDetailClick("+JSON.stringify(_datas[i])+",0)'>"+
                                                    "<span class='line'></span>"+
                                                    "<span class='btn'>查看详情</span>"+
                                                "</div>"+
                                            "</div>"+
                                        "</li>";
                                    _ul+=_li
                                }
                                $('#streetDetailUl').html(_ul)
                            }
                        }else{
                            $('#streetDetailUl').html('<div class="noData">暂无数据！</div>')
                        }
                    }
                }
            })
        }

        /*点位详情-问题统计*/
        function monthStatis(){
            
            let _url = $.config.apiUrl+'/count/errorCountByPointGroupByWeek';
            let _ars={"pointId":_details.pointId}
            $.ajax({
                url: _url,
                data: JSON.stringify(_ars),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                async: false,
                success: function(data){
                    if(data.code==200){
                        if(data.data!==null){
                            var _weeks = ['第一周','第二周','第三周','第四周','第五周','第六周','第七周',]
                            let _names=[]
                            let _datas=[]
                            for(let i=0; i<data.data.length; i++){
                                _names.push(_weeks[i])
                                _datas.push(data.data[i].countValue)
                            }
                            //问题统计
                            let dom = document.getElementById("monthId");
                            //清楚数据
                            dom.removeAttribute("_echarts_instance_");
                            let myChart = echarts.init(dom);
                            let option = null;
                            let _showsWeek=''
                            option = {
                                tooltip: {
                                    trigger: 'axis',
                                    axisPointer: {
                                        type: 'cross',
                                        label: {
                                            backgroundColor: '#6a7985'
                                        }
                                    },
                                    formatter: s=>{
                                        let _index = s[0].dataIndex 
                                        _showsWeek=''
                                        _showsWeek = _weeks[_index]+'<br/>'+(data.data[_index].start).substring(0,10) +' 至 '+(data.data[_index].end).substring(0,10)
                                        return _showsWeek
                                    }
                                },
                                xAxis: [
                                    {
                                        type: 'category',
                                        boundaryGap: false,
                                        axisLabel: {
                                            show: true,
                                            textStyle: {
                                                color: '#ffffff'
                                            }
                                        },
                                        data: _names
                                    }
                                ],
                                yAxis: [
                                    {
                                        type: 'value',
                                        axisLabel: {
                                            show: true,
                                            textStyle: {
                                                color: '#ffffff'
                                            }
                                        },
                                        splitLine:{
                                            show: true,
                                            lineStyle:{
                                                color: 'rgba(0, 145, 255, 0.2)'
                                            }
                                        },
                                    }
                                ],
                                series: [
                                    {
                                        name: _showsWeek,
                                        type: 'line',
                                        stack: '总量',
                                        areaStyle: {
                                            normal: {
                                                color: 'rgba(247, 181, 0, 0.4)'
                                            }
                                        },
                                        data: _datas
                                    },
                                ]
                            };
                            if (option && typeof option === "object") {
                                myChart.setOption(option, true);
                            }


                        }else{
                            $('#monthId').html('<div class="noData">暂无数据!</div>')
                        }
                    }
                }
            })
        }

        //自动换行--统计数据表文字
        function getLines(e){
            let _datas = e.split('')
　　　　     let newStr=" ";  　　
            let _num = 14
            for(let i=0;i<_datas.length;i++){ 　
                if(i%_num==0&&i!==0){
                    newStr+=_datas[i]+'<br/>'
                }else{
                    newStr+=_datas[i]　
                }　　　　　　　     　　　　　　　　　  
            }
            return newStr
        }  

        /*点位详情-问题分布*/
        function distribStatis(){

            let _url = $.config.apiUrl+'/count/errorItemCountByPoint';
            let _ars={"pointId":_details.pointId}
            $.ajax({
                url: _url,
                data: JSON.stringify(_ars),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                async: false,
                success: function(data){
                    if(data.code==200){
                        if(data.data!==null&&data.data.length>0){
                            let _datas = data.data
                            let _names = []
                            let _datas2=[]
                            for(let i=0; i<_datas.length; i++){
                                let _ar={}
                                _ar.value = _datas[i].error_count
                                _ar.name = _datas[i].item_text
                                _datas2.push(_ar)
                                _names.push(_datas[i].item_text)
                            }

                            let dom = document.getElementById("problemId");
                            //清楚数据
                            dom.removeAttribute("_echarts_instance_");
                            let myChart = echarts.init(dom);
                            let option = null;
                            let _showsWeek=''
                            option = {
                                tooltip: {
                                    show:true,
                                    trigger: 'item',
                                    formatter: s=>{
                                        let _index = s.dataIndex 
                                        _showsWeek=''
                                        let _newHtml = getLines(_datas[_index].item_text)
                                        _showsWeek = '<div style="float: left; width: 200px;">问题数量：'+_datas[_index].error_count+'<br/><p style="word-break:break-all;">'+_newHtml+'</p></div>';
                                        return _showsWeek
                                    }
                                },
                                color:['#FF6F61','#0091FF','#FF974D','#F7B500','#44D7B6'],
                                series: [
                                    {
                                        name: '',
                                        type: 'pie',
                                        radius: ['50%', '70%'],
                                        avoidLabelOverlap: false,
                                        label: {
                                            show: false,
                                            position: 'center'
                                        },
                                        emphasis: {
                                            label: {
                                                show: true,
                                                fontSize: '16',
                                            }
                                        },
                                        labelLine: {
                                            show: false
                                        },
                                        data: _datas2,
                                        label: {
                                            normal: {
                                                show: false,
                                                position: 'center',
                                                formatter:function (argument) {
                                                    var html;
                                                    html='问题数量\r\n\r\n'+argument.value;
                                                    return html;
                                                },
                                                textStyle:{
                                                   fontSize: 14,
                                                   color:'#fff'
                                                }
                                            }
                                        },
                                    }
                                ]
                            };
                            if (option && typeof option === "object") {
                                myChart.setOption(option, true);
                            }
                        }else{
                            $('#problemId').html('<div class="noData" style="margin-top: 80px;">暂无问题分布数据！</div>')
                        }
                        let _data = data.data
                    }
                }
            })        
        }

        /*websocket连接*/
        function setSocket(){
            if ("WebSocket" in window) {
                let _urls = $.config.wsUrl+'/'+_employeeId
                var ws = new WebSocket(_urls);
                socket = ws;
                ws.onopen = function() {
                    console.log('连接成功');
                };
                ws.onmessage = function(evt) {
                    //console.log(evt)
                    let _data = JSON.parse(evt.data)
                    //console.log(_data.type)
                    if(_data.type == 'watchevent'){
                        if(_data.data.status==1){
                            //发信号
                            let _ar={}
                            _ar.id = _data.data.id
                            _ar.styleId = 'styleRole4'
                            _ar.position = new TMap.LatLng(_data.data.lat, _data.data.lng)
                            _ar.eventTime = getTimes(_data.data.eventTime)
                            _ar.properties= JSON.parse(_data.data.subsidiary)
                            _ar.properties.type = 'signal' //类型，信号
                            _ar.properties.employeeId = _data.data.employeeId //类型，信号
                            markerLayer.add(_ar)
                            //添加圆
                            setCircles(_data.data)
                            //隐藏弹窗
                            hideAlertBg()
                        }else if(_data.data.status==2){
                            //取消信号
                            markerLayer.remove([_data.data.id])
                            //圆数据取消
                            circlefun.remove(_data.data.id)
                            //隐藏弹窗
                            hideAlertBg()
                        }
                    }else if(_data.type == 'immsg'){
                        if(_messageList.length==0||_messageList[_messageList.length-1].msgId!==_data.data.msgId){
                            let _times = $.config.setTimes(_data.data.createTime)
                            _data.data.createTime= _times
                            _messageList.push(_data.data)
                            //追加消息
                            pushMess(_data.data,0)
                            //标记已读
                            //this.setRead(_a)
                            scrollToBottom()
                        }
                    }else if(_data.type == 'noticeInfo'){
                        if(_noticeSys == true){
                            let _notiData = _data.data
                            $('.noticeBox').removeClass('hide')
                            $('.noticeIcon').addClass('hide')
                            $('.noticeBox #noticeId').html('创城通知：'+_notiData.noticeText)
                            //图片是否一张
                            let _isnew = (_notiData.noticeTitle).indexOf('isNew')
                            if(_isnew>0){
                                let _imgsHtml=''
                                let _imgData = JSON.parse(_notiData.noticeTitle)
                                let _imgs = _imgData.imglist.split(',')
                                _imgs.map(item=>{
                                    let _src = $.config.imgCom+item
                                    _imgsHtml+="<div class='noticeImg'><img class='img' src="+_src+" onClick='imgsClick(\""+_src+"\")' /></div>"
                                })
                                $('.noticeBox #noticeImgs').removeClass('hide')
                                $('.noticeBox #noticeImgs').html(_imgsHtml)
                            }else{
                                $('.noticeBox #noticeImgs').addClass('hide')
                            }
                        }
                    }
                };
                ws.onclose = function() {
                    alert("断开了连接");
                };
            } else {
                alert("浏览器不支持WebSocket");
            }
        }

        //隐藏地图弹窗
        function hideAlertBg(){
            $('.alertBg').parent().parent().hide()
        }

        //指挥消息-消息相关操作。
        function setMessages(){
            //获取聊天室列表
            let _ars = {"memberId":_employeeId}
            let _url = $.config.apiUrl + '/im/listChatRom'
            $.ajax({
                url: _url,
                data: JSON.stringify(_ars),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                success: function(res){
                    if(res.code==200){
                        if(res!==null&&res.data.length>0){
                            let _shows=[]
                            for(let i=0; i<res.data.length; i++){
                                if(res.data[i].chatName=='迎检群'){
                                    res.data[i].chatName = '通知群'
                                    messageGroup = res.data[i];
                                    _chatId = res.data[i].chatId
                                }else{
                                    _shows.push(res.data[i])
                                }
                            }
                            messageManList = _shows;
                            //获取消息-群
                            //getMessageList(_chatId)
                            getMessageList('9527')
                        }else{
                            //获取消息-群
                            _chatId='9527'
                            getMessageList('9527')
                        }
                    }
                },
                error: function(err){   
                    alert('消息列表获取失败')
                }
            })
        }

        //消息-和指定的人聊天
        function chatOne(tarId,name){
            _messageList=[]
            _isScroll=true //更新滚动条事件
            //清空聊天数据
            $('#chatView').html('')
            $('.chatBox').removeClass('hide')
            //隐藏通讯录
            $('.telbookBox').addClass('hide')
            //显示个人
            let _name = '和'+name+'的聊天'
            $('.chatBox .chat-name').html(_name)
            let _url = $.config.apiUrl + '/im/createChatRom'
            let _ars={}
            _ars.fromId = _employeeId
            _ars.tarId = tarId //'0000000071727edd017177d2562b01b5' //tarId
            //创建聊天池
            $.ajax({
                url: _url,
                data: JSON.stringify(_ars),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                success: function(res){
                    if(res.code==200){
                        _chatId = res.data.chatId
                        getMessageList(_chatId)
                    }
                },
                error: function(err){   
                    alert('消息列表获取失败')
                }
            })
        }

        /*消息滚动到底部*/
        function scrollToBottom(){
            //消息
            let _height = $('#chatView').prop("scrollHeight")
            $('#chatView').scrollTop(_height,0)
        }

        /*消息滚动到底部*/
        function scrollToBottom2(){
            //信号
            let _height2 = $('#signalView').prop("scrollHeight")
            $('#signalView').scrollTop(_height2,0)
        }

        //获取消息-list
        function getMessageList(chatIds){
            //获取聊天人员列表
            let _ars={"chatId":chatIds}
            let _url = $.config.apiUrl + '/im/currentMsg'
            $.ajax({
                url: _url,
                data: JSON.stringify(_ars),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                success: function(res){
                    if(res.code==200){
                        if(res.data!==null&&res.data.length>0){
                            let _res = res.data.reverse()
                            //消息列表
                            _messageList = _res
                            //最新一条数据，时间
                            newTime = res.data[0].createTime
                            //设置消息
                            for(let i=0; i<res.data.length; i++){
                                pushMess(res.data[i],0)
                            }
                            setTimeout(()=>{
                                scrollToBottom()
                            },50)
                        }else{
                            $('#chatView').html('<div class="noData">暂无消息!</div>')
                        }
                    }
                },
                error: function(err){   
                    alert('消息列表获取失败')
                }
            })
        }

        //下拉加载更多 - 消息
        function getMsg(arrs){
            let _ars=arrs
            let _url = $.config.apiUrl + '/im/listMSG'
            $.ajax({
                url: _url,
                data: JSON.stringify(_ars),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                success: function(data){
                    if(data.code==200){
                        let _div = '<div class="noData">无更多聊天记录！</div>'
                        if(data.data!==null&&data.data.length>0){
                            //无更多
                            let _length = data.data.length
                            newTime = data.data[_length-1].createTime
                            for(let i=0; i<_length; i++){
                                pushMess(data.data[i],1)
                            }
                            if(_length<_rows){
                                _isScroll=false
                                $('#chatView').prepend(_div)
                            }
                        }else{
                            _isScroll=false
                            $('#chatView').prepend(_div)
                        }
                    }
                }
            })
        }

        //将消息添加到列表
        function pushMess(datas,k){
            let _li=''
            let _head = setHead(datas.memberImg)
            let _content = ''
            if(datas.msgType==1||datas.msgType==3){
                //文字
                _content = "<div class='cont'>"+
                            "<div>"+datas.msgContent+"</div>"+
                        "</div>";
            }else if(datas.msgType==2){
                //图片
                let _imgs = setHead(datas.msgContent)
                _content = "<div class='cont imgcont'>"+
                            "<img class='img' src='"+_imgs+"' onClick='imgsClick("+JSON.stringify(_imgs)+")' />"+
                        "</div>";
            }else if(datas.msgType==4){
                //地图
                _content = "<div class='cont mapcont'>"+
                                "<img class='img' src='"+datas.msgContent+"'/>"+
                        "</div>";
            }
            if(datas.memberId !== _employeeId){
                _li = "<li class='msgitem'>"+
                            "<div class='msg-time'>"+datas.createTime+"</div>"+
                            "<div class='msg-cont'>"+
                                "<div class='msg-imgBox'>"+
                                    "<div class='imgBox'>"+
                                        "<img class='img' current='1' src='"+_head+"' />"+
                                    "</div>"+
                                "</div>"+
                                "<div class='msg-message'>"+
                                    "<div class='maninfo'>"+
                                        "<span class='name'>"+datas.memberName+"</span>"+
                                        "<span class='phone'>"+datas.memberPhone+"</span>"+
                                        "<span class='name orgs'>"+datas.memberOrgs+"</span>"+
                                    "</div>"+
                                    _content+
                                "</div>"+
                            "</div>"+
                        "</li>"
            }else{
                _li = "<li class='msgitem msgitem-me'>"+
                            "<div class='msg-time'>"+datas.createTime+"</div>"+
                            "<div class='msg-cont'>"+
                                "<div class='msg-message'>"+
                                    "<div class='maninfo'>"+
                                        "<span class='name'>"+datas.memberName+"</span>"+
                                        "<span class='phone'>"+datas.memberPhone+"</span>"+
                                        "<span class='name orgs'>"+datas.memberOrgs+"</span>"+
                                    "</div>"+
                                    _content+
                                "</div>"+
                                "<div class='msg-imgBox'>"+
                                    "<div class='imgBox'>"+
                                        "<img class='img' src='"+_head+"' />"+
                                    "</div>"+
                                "</div>"+
                            "</div>"+
                        "</li>"
            }
            if(k==0){
                $('#chatView').append(_li)
            }else{
                $('#chatView').prepend(_li) 
            }
            
        }

        //发送消息
        function sendChat(k,datas){
            if(isSend){
                let _url = $.config.apiUrl +  '/im/sendMSG'
                isSend = false
                let _ars = {}
                if(k==1){
                    //提交图片
                    _ars.chatId = _chatId
                    _ars.memberId= _employeeId
                    _ars.msgContent= datas
                    _ars.msgType=2 
                }else if(k==2){
                    //地理位置
                    _ars.chatId = _chatId
                    _ars.memberId= _employeeId
                    let _cont = 'https://apis.map.qq.com/ws/staticmap/v2/?center='+_lat+','+_lng+'&zoom=14&size=600*300&maptype=roadmap&markers=size:large|color:0xFFCCFF|label:k|'+_lat+','+_lng+'&key='+_keys;
                    _ars.msgContent= _cont 
                    _ars.msgType=4 
                }else{
                    //提交文字
                    let _text=''
                    if(datas==1){
                        _text = $('#textarea1').val()
                    }else{
                        _text = datas
                    }
                    if(_text==''){
                        return false
                    }
                    _ars.chatId = _chatId
                    _ars.memberId= _employeeId
                    _ars.msgContent= _text
                    _ars.msgType=1
                }
                setTimeout(()=>{
                    isSend = true
                },800)

                $.ajax({
                    url: _url,
                    data: JSON.stringify(_ars),
                    type: "POST",
                    contentType: "application/json",
                    dataType: "json",
                    success: function(res){
                        if(res.code==200){
                            //滚动条到最底部,并且清空文本域
                            $('#textarea1').val('')
                            //判断是否添加到底部
                            if(_messageList.length==0||_messageList[_messageList.length-1].msgId!==res.msgId){
                                let _newArrs = _messageList
                                _newArrs.push(res)
                                _messageList = _newArrs
                                /*let _a={}
                                _a.icrmId = that.icrmId
                                _a.lastReadTime = res.createTime
                                //标记已读
                                setRead(_a)*/
                            }
                            /*setTimeout(()=>{
                                that.scrollToBottom()
                            },50) */
                        }
                    },
                    error: function(err){   
                        alert('消息发送失败!'+err)
                    }
                })
            }
        }

        //标记消息已读
        function setRead(ar){
            let _url = $.config.apiUrl + '/im/markLastReadTime'
            let _ars = ar
            $.ajax({
                url: _url,
                data: JSON.stringify(_ars),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                success: function(res){},
                error: function(err){}
            })
        }
        
        //获取事件列表
        function getEventList(){
            let _url =  $.config.apiUrl + '/watchEvent/listEvent' 
            let _ars={}
            $.ajax({
                url: _url,
                data: JSON.stringify(_ars),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                success: function(res){
                    if(res.code==200){
                        if(res.data.length==0){
                            $('#signalView').html('<div class="noData">暂无信号!</div>')
                            return false
                        }
                        let _data = res.data.reverse()
                        //信号数据-清空
                        _dataRole4=[]
                        let _ul=''
                        for(let i=0; i<_data.length; i++){
                            if(_data[i].eventName == '发信号'&&_data[i].status==1){
                                _dataRole4.push(_data[i])
                                //发信号
                                let _subsidiary = JSON.parse(_data[i].subsidiary)
                                _subsidiary.employeeId = _data[i].employeeId
                                let _ar={}
                                _ar.id = _data[i].id
                                _ar.styleId = 'styleRole4'
                                _ar.position = new TMap.LatLng(_data[i].lat, _data[i].lng)
                                _ar.eventTime = _data[i].eventTime
                                _ar.properties= _subsidiary
                                _ar.properties.type = 'signal' //类型，点位
                                markerLayer.add(_ar)
                                //添加圆
                                setCircles(_data[i])

                                //信号管理数据
                                let _li = ''
                                let _head = setHead(_subsidiary.avatar)
                                if(_data[i].employeeId!==_employeeId){
                                    _li = "<li class='msgitem'>"+
                                            "<div class='msg-time'>"+_data[i].eventTime+"</div>"+
                                                "<div class='msg-cont'>"+
                                                    "<div class='msg-imgBox'>"+
                                                        "<div class='imgBox'>"+
                                                            "<img class='img' current='1' src='"+_head+"' />"+
                                                        "</div>"+
                                                        "<div class='msg-name'>"+_subsidiary.name+"</div>"+
                                                        "<div class='signalBox' onclick='cancleSignal("+JSON.stringify(_data[i])+','+'0'+");'>"+
                                                            "<div class='imgBox'>"+
                                                                "<image src='../images/signal-close.png' class='img' />"+
                                                            "</div>"+
                                                            "<div class='text'>关闭信号</div>"+
                                                        "</div>"+
                                                    "</div>"+
                                                    "<div class='msg-message'>"+
                                                        "<div class='cont contFlex'>"+
                                                            "<div class='myaddr'>"+_subsidiary.address+"</div>"+
                                                                "<div class='imgBox'>"+
                                                                    "<img class='img' src='"+_subsidiary.msgContent+"' />"+
                                                                "</div>"+
                                                            "</div>"+
                                                        "</div>"+
                                                    "</div>"+
                                            "</li>"
                                }else{
                                    _li = "<li class='msgitem msgitem-me'>"+
                                                "<div class='msg-time'>"+_data[i].eventTime+"</div>"+
                                                "<div class='msg-cont'>"+
                                                    "<div class='msg-message'>"+
                                                        "<div class='cont contFlex'>"+
                                                            "<div class='myaddr'>"+_subsidiary.address+"</div>"+
                                                                "<div class='imgBox'>"+
                                                                     "<img class='img' src='"+_subsidiary.msgContent+"' />"+
                                                                "</div>"+
                                                            "</div>"+
                                                        "</div>"+
                                                        "<div class='msg-imgBox' @click='toUserinfo'>"+
                                                            "<div class='imgBox'>"+
                                                                "<img class='img' src='"+_head+"' />"+
                                                            "</div>"+
                                                            "<div class='msg-name'>"+_subsidiary.name+"</div>"+
                                                                "<div class='signalBox' onclick='cancleSignal("+JSON.stringify(_data[i])+','+'0'+");'>"+
                                                                    "<div class='imgBox'>"+
                                                                        "<image src='../images/signal-close.png' class='img' />"+
                                                                    "</div>"+
                                                                    "<div class='text'>关闭信号</div>"+
                                                                "</div>"+
                                                            "</div>"+
                                                        "</div>"+
                                                    "</li>"
                                }
                                _ul+=_li
                            }
                        }
                        $('#signalView').html(_ul)
                        setTimeout(()=>{
                            scrollToBottom2()
                        },10)
                    }
                },
                error: function(err){}
            })
        }

        //设置头像
        function setHead(imgs){
            if(imgs==null||imgs==''){
                return '../images/head-blue.png'
            }else if(imgs.indexOf('https')>0){
                return imgs
            }else{
                return $.config.imgCom + imgs
            }
        }

        //查询员工信息
        function queryEmployee(ids){
            let _url = $.config.apiUrl + '/employee/info'
            let _ars = {"employeeId":ids}
            let _datas
            $.ajax({
                url: _url,
                data: JSON.stringify(_ars),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                async: false,
                success: function(res){
                    if(res.code == 200){
                        _datas = res.data
                    }
                },
                error: function(err){}
            })
            return _datas
        }

        //返回员工信息-机构
        function getEmployeeOrg(datas){
            if(datas==null){
                return ''
            }
            let _datas = datas.orgs
            let _name=''
            if(_datas!==null){
                for(let i=0; i<_datas.length; i++){
                    _name+=_datas[i].orgName+'、'
                }
            }
            _name = _name.substring(0, _name.length - 1);  
            return _name
        }

        //发信号-获取地址
        function sendSignal(datas){
            //确定要发送信号
            //sendSignal2(datas)
            var option = {
                title:'提示',
                msg:'确定要发送信号吗？',
                confirm:function(){
                    getAddress(datas.lat,datas.lng,datas)
                },
                cancel:function(){
                    console.log('取消')
                }
            };
            confirm_tips(option);
        }

        //修改检查点
        function updateDots(data){
            $('.editDots').removeClass('hide')
            _DotId = data.pointId
            let _shows = JSON.parse(data.subsidiary)
            $('#addDot-name2').val(data.pointName)
            $('#addDot-inspect2').val(_shows.inspect)
            $('#addDot-remark2').val(_shows.remarks)
            //隐藏
            $('.alertBg2').hide()
            $('.alertArrorBg').hide()
        }

        //删除检查点
        function delDots(ids){
            var option = {
                title:'提示',
                msg:'确定要删除该标记吗？',
                confirm:function(){
                    let _ars={}
                    _ars.pointId = ids
                    let _url = $.config.apiUrl + '/checkpoint/del'
                    $.ajax({
                        url: _url,
                        data: JSON.stringify(_ars),
                        type: "POST",
                        async: false,
                        contentType: "application/json",
                        dataType: "json",
                        success: function(res){
                            //隐藏提示
                            $('.alertBg2').hide()
                            $('.alertArrorBg').hide()
                            $.messageTip.success({
                                message:"删除成功...",
                                fadeInTimeOut : 1,   //滑入秒数
                                contentTimeOut : 3,  //内容停留秒数 
                                fadeOutTimeOut : 1, ////滑出秒数
                            });
                            //删除点
                            markerLayer.remove(ids)
                             
                        },
                        error: function(err){}
                    })
                },
                cancel:function(){
                    console.log('取消')
                }
            };
            confirm_tips(option);
        }

        //封装弹窗回调
        function confirm_tips(obj){
            if(!obj.title){
                obj.title = '系统提示';
             }
            var tips_html = "<div class='alertBgs blueBackBg'>"+
                                "<div class='linebg lineBg-lt'></div>"+
                                "<div class='linebg lineBg-lb'></div>"+
                                "<div class='linebg lineBg-rt'></div>"+
                                "<div class='linebg lineBg-rb'></div>"+
                                "<div class='titles center'>"+obj.title+"</div>"+
                                "<div class='titles'>"+obj.msg+"</div>"+
                                "<div class='cont'>"+
                                    "<span class='btn sure'>确定</span>"+
                                    "<span class='btn cancle'>取消</span>"+
                                "</div>"
                            "</div>";
            if($('.alertBgs').length <= 0){
                $('.maxBg').append(tips_html);
            }
            $('.alertBgs .cont .sure').click(function(){
                if(obj.confirm){
                    obj.confirm();
                }
                $('.alertBgs').remove();
            })
            $('.alertBgs .cont .cancle').click(function(){
                if(obj.cancel){
                    obj.cancel();
                }
                $('.alertBgs').remove();
            })
        }

        //发信号-真实发送
        function sendSignal2(datas){
            //在员工的位置，标记一次信号
            let _url =  $.config.apiUrl + '/watchEvent/addEvent' 
            let _ars= {"employeeId":_employeeId,"eventName":"发信号","lat":datas.lat,"lng": datas.lng,types:'mess'}
            let _json = _employees
            _json.msgContent = 'https://apis.map.qq.com/ws/staticmap/v2/?center='+datas.lat+','+datas.lng+'&zoom=14&size=600*300&maptype=roadmap&markers=size:large|color:0xFFCCFF|label:k|'+datas.lat+','+datas.lng+'&key='+_keys;
            _json.address= _address
            _ars.subsidiary = JSON.stringify(_json)
            $.ajax({
                url: _url,
                data: JSON.stringify(_ars),
                type: "POST",
                async: false,
                contentType: "application/json",
                dataType: "json",
                success: function(res){},
                error: function(err){}
            })
        }

        //关闭信号
        function cancleSignal(datas,k){
            let _cancelEmployeeId;
            if(k==0){
                _cancelEmployeeId = datas.employeeId
            }else{
                _cancelEmployeeId = datas.properties.id
            }
            let _that = $(this);
            let _url =  $.config.apiUrl + '/watchEvent/cancelEvent' 
            let _ars= {"id":datas.id,"cancelEmployeeId":_cancelEmployeeId}
            $.ajax({
                url: _url,
                data: JSON.stringify(_ars),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                success: function(res){
                    if(k==0){
                        //移除信号管理。消息
                        getEventList()
                    }
                    
                },
                error: function(err){
                    alert('关闭信号失败,'+err)
                }
            })
        }

        //添加圆
        function setCircles(datas){
            let _subsidiary = JSON.parse(datas.subsidiary)
            _subsidiary.type = 'signal'
            let _ar={}
            _ar.id = datas.id
            _ar.styleId = 'circle'
            _ar.center= new TMap.LatLng(datas.lat, datas.lng)
            _ar.radius = 500 //半径，m
            _ar.properties = datas._subsidiary
            circlefun.add(_ar)
        }

        //获取通讯录
        function getTelbook(names){
            let _url =  $.config.apiUrl + '/employee/list' 
            let _ars={}
            _ars.pageIndex = 1
            _ars.pageSize = 100
            if(names!==''){
                _ars.name = names 
            } 
            $.ajax({
                url: _url,
                data: JSON.stringify(_ars),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                success: function(res){
                    if(res.code==200&&res.data.data!==null){
                        let _data = res.data.data
                        let _ul=''
                        for(let i=0; i<_data.length; i++){
                            let _img = setHead(_data[i].avatar)
                            let _li="<li class='message-list'>"+
                                        "<div class='li-img' onclick='chatOne("+JSON.stringify(_data[i].id)+','+JSON.stringify(_data[i].name)+");'>"+
                                            "<img class='img' src='"+_img+"' />"+
                                        "</div>"+
                                        "<div class='li-cont'>"+
                                            "<div>"+
                                                "<text class='name'>"+_data[i].name+"</text>"+
                                                "<text class='name orgs'>"+_data[i].employeeOrgs+"</text>"+
                                            "</div>"+
                                            "<div>"+
                                                "<text class='mess' style='color: #0091FF;'>"+_data[i].phone+"</text>"+
                                                "</div>"+
                                            "</div>"+
                                    "</li>"
                            _ul+=_li
                        }
                        $('#telbookView').html(_ul)
                    }else{
                        $('#telbookView').html('<div class="noData">暂无联系人!</div>')
                    }
                },
            })
        }

        /*图片上传*/
        function uploadFiles(){
            let _url = $.config.apiUrl+'/upload/singleFile'
            var file = document.getElementById('uploadfile');
            var image = document.querySelector("img");

            file.onchange = function() {
                var fileData = this.files[0];//获取到一个FileList对象中的第一个文件( File 对象),是我们上传的文件
                var myform = new FormData();
                myform.append('file',fileData);
                $.ajax({
                url: _url,
                type: "POST",
                data: myform,
                contentType: false,
                processData: false,
                success: function (data) {
                    if(data.code==200){
                        sendChat(1,data.data)
                    }
                },
                error:function(data){
                    console.log(data)
                }
            });
            }
           
        }

        //在线日期
        function showTime() { 
            let now = new Date(); 
            let year = now.getFullYear();
            let month = now.getMonth()+1;
            let day = now.getDate();
            let hour = now.getHours();
            let minute = now.getMinutes();
            let second = now.getSeconds();
            let week = now.getDay(); //星期 
            //判断星期几 
            let weeks = ["日","一","二","三","四","五","六"]; 
            let getWeek = "星期" + weeks[week]; 
            $('.topBg .rightBg .times').html(year+'年'+month+'月'+day+'日  ' + getWeek)
            $('.topBg .rightBg .big').html(hour+':'+minute+':'+second)
            setTimeout('showTime()',1000); 
            $('.topBg .rightBg .big').html(hour+':'+minute+':'+second)
        } 

        //获取天气
        function getWeather(){
            $('.topBg .leftBg .time2').html(_employees.name)
            $('.topBg .leftBg .time1').html(_employees.phone)
            /*$.ajax({
                url: "https://ditu.amap.com/service/weather?adcode=310000",
                type: "get",
                contentType: "application/json",
                dataType: "json",
                success: function(res){
                    console.log(res)
                }
            })*/
        }

        //显示人员线路-弹窗
        function showLineBox(data){
            _lineData  = data
            $('.lineSetting').removeClass('hide')
            //默认今天
            if(_startTimeLine==null||_endTimeLine==null){
                _startTimeLine = $.config.todayStart()
                _endTimeLine = $.config.todayEnd()
                $('#dateSelect').val(_startTimeLine+' - '+ _endTimeLine)
            }

            if(_lineMap==null){
                //定义线条样式
                let _lineStyle={}
                for(let i=0; i<_bgcolor.length; i++ ){
                    let _name = 'style_'+i
                    _lineStyle[_name] = new TMap.PolylineStyle({
                        'color': _bgcolor[i], //线填充色
                        'width': 6, //折线宽度
                        'lineCap': 'butt' //线端头方式
                    })
                }

                //线路轨迹
                _lineMap = new TMap.MultiPolyline({
                    id: 'polyline-layer2',
                    map: _map,
                    styles: _lineStyle,
                    //折线数据定义
                    geometries: []
                });
            }
        }

        //显示人线路-line
        function showLine(data,k){
            let _url =  $.config.apiUrl + '/employee/listGPS' 
            let _ars={}
            _ars.employeeId= data.employeeId
            _ars.startTime = data.startTime
            _ars.endTime = data.endTime
            _ars.pageIndex = 1
            _ars.pageSize = 5000
            _ars.recordType = k
            $.ajax({
                url: _url,
                data: JSON.stringify(_ars),
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                success: function(res){
                    if(res.code==200&&res.data.data!==null){
                        let _paths=[]
                        let _datas = res.data.data
                        if(_datas.length==1){
                            alert('该人员只有一个点，无法形成线路！')
                            closeLine(data)
                            return false
                        }
                        for(let i=0; i<_datas.length; i++){
                            let _ar = new TMap.LatLng(_datas[i].lat,_datas[i].lng)
                            _paths.push(_ar)
                        }
                        //显示几号线。
                        let _startLine = new TMap.LatLng(_datas[0].lat,_datas[0].lng)
                        //生成折线
                        setLines(data,_paths,_startLine)
                    }else{
                        //关闭重复更新。
                        clearInterval(data.interval)
                        data.interval=null
                        alert('该人员暂无线路！')
                    }
                    
                }
            })
        }

        function setLines(data,paths,starts){
            let _styleL = 'style_'+ data.index
            let _lineId = 'pl_'+ data.phone
            if(data.isone==null){
                //只执行一次，跳转到中心
                let _news =  new TMap.LatLng(_lineData.lat,_lineData.lng)
                /*_map.setCenter(_news)
                _map.setZoom(20)*/
                let _ars={
                    'id': _lineId, //折线唯一标识，删除时使用
                    'styleId': _styleL,//绑定样式名
                    'paths': paths
                }
                data.isone = 1
                _lineMap.add(_ars)
            }else{
                _lineMap.remove(_lineId)
                let _ars={
                    'id': _lineId, //折线唯一标识，删除时使用
                    'styleId': _styleL,//绑定样式名
                    'paths': paths
                }
                _lineMap.add(_ars)
            }
            //设置起点坐标
            let _startDa = {}
            _startDa.id = 'lines_'+data.phone
            _startDa.styleId = 'lines'+(data.index+1)
            _startDa.position = starts
            _startDa.properties= data
            _startDa.properties.type = 'lines' //类型，点位
            markerLayer.add(_startDa)
        }

        //隐藏线路
        function closeLine(data){
            let _k=null
            for(let i=0; i<_lineUser.length; i++){
                if(_lineUser[i].employeeId == data.employeeId){
                    _k = i
                    break;
                }
            }
            if(_k!==null){
                let _interval = 'setInter_'+data.employeePhone
                let _lineIds = 'pl_' + data.employeePhone
                //关闭试试更新
                clearInterval(_lineUser[_k].interval)
                _lineUser[_k].interval=null
                _lineMap.remove(_lineIds)
                //关闭线路点图标
                let _markIds = 'lines_'+data.employeePhone
                markerLayer.remove(_markIds)
            }
        }
    </script>
</html>
